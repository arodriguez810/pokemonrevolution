"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = require("lodash");

var _asyncOra = require("@electron-forge/async-ora");

var _templateBase = _interopRequireDefault(require("@electron-forge/template-base"));

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _initGit = _interopRequireDefault(require("./init-scripts/init-git"));

var _initNpm = require("./init-scripts/init-npm");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = require("../util/forge-config");

var _messages = require("../util/messages");

var _installDependencies = _interopRequireWildcard(require("../util/install-dependencies"));

var _readPackageJson = require("../util/read-package-json");

var _upgradeForgeConfig = _interopRequireWildcard(require("../util/upgrade-forge-config"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:import');

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  confirmImport,
  shouldContinueOnExisting,
  shouldRemoveDependency,
  shouldUpdateScript,
  outDir
}) => {
  const calculatedOutDir = outDir || 'out';
  _asyncOra.asyncOra.interactive = interactive;
  d(`Attempting to import project in: ${dir}`);

  if (!(await _fsExtra.default.pathExists(dir)) || !(await _fsExtra.default.pathExists(_path.default.resolve(dir, 'package.json')))) {
    throw new Error(`We couldn't find a project in: ${dir}`);
  } // eslint-disable-next-line max-len


  if (typeof confirmImport === 'function') {
    if (!(await confirmImport())) {
      process.exit(0);
    }
  }

  await (0, _initGit.default)(dir);
  const importDeps = [].concat(_initNpm.deps);
  let importDevDeps = [].concat(_initNpm.devDeps);
  let importExactDevDeps = [].concat(_initNpm.exactDevDeps);
  let packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);

  if (packageJSON.config && packageJSON.config.forge) {
    if (packageJSON.config.forge.makers) {
      (0, _messages.warn)(interactive, 'It looks like this project is already configured for Electron Forge'.green);

      if (typeof shouldContinueOnExisting === 'function') {
        if (!(await shouldContinueOnExisting())) {
          process.exit(0);
        }
      }
    } else if (typeof packageJSON.config.forge === 'string') {
      (0, _messages.warn)(interactive, "We can't tell if the Electron Forge config is compatible because it's in an external JavaScript file, not trying to convert it and continuing anyway".yellow);
    } else {
      d('Upgrading an Electron Forge < 6 project');
      packageJSON.config.forge = (0, _upgradeForgeConfig.default)(packageJSON.config.forge);
      importDevDeps = (0, _upgradeForgeConfig.updateUpgradedForgeDevDeps)(packageJSON, importDevDeps);
    }
  }

  packageJSON.dependencies = packageJSON.dependencies || {};
  packageJSON.devDependencies = packageJSON.devDependencies || {};
  [importDevDeps, importExactDevDeps] = (0, _electronVersion.updateElectronDependency)(packageJSON, importDevDeps, importExactDevDeps);
  const keys = Object.keys(packageJSON.dependencies).concat(Object.keys(packageJSON.devDependencies));
  const buildToolPackages = {
    '@electron/get': 'already uses this module as a transitive dependency',
    'electron-builder': 'provides mostly equivalent functionality',
    'electron-download': 'already uses this module as a transitive dependency',
    'electron-forge': 'replaced with @electron-forge/cli',
    'electron-installer-debian': 'already uses this module as a transitive dependency',
    'electron-installer-dmg': 'already uses this module as a transitive dependency',
    'electron-installer-flatpak': 'already uses this module as a transitive dependency',
    'electron-installer-redhat': 'already uses this module as a transitive dependency',
    'electron-osx-sign': 'already uses this module as a transitive dependency',
    'electron-packager': 'already uses this module as a transitive dependency',
    'electron-winstaller': 'already uses this module as a transitive dependency'
  };

  for (const key of keys) {
    if (buildToolPackages[key]) {
      const explanation = buildToolPackages[key]; // eslint-disable-next-line max-len

      let remove = true;

      if (typeof shouldRemoveDependency === 'function') {
        remove = await shouldRemoveDependency(key, explanation);
      }

      if (remove) {
        delete packageJSON.dependencies[key];
        delete packageJSON.devDependencies[key];
      }
    }
  }

  packageJSON.scripts = packageJSON.scripts || {};
  d('reading current scripts object:', packageJSON.scripts);

  const updatePackageScript = async (scriptName, newValue) => {
    if (packageJSON.scripts[scriptName] !== newValue) {
      // eslint-disable-next-line max-len
      let update = true;

      if (typeof shouldUpdateScript === 'function') {
        update = await shouldUpdateScript(scriptName, newValue);
      }

      if (update) {
        packageJSON.scripts[scriptName] = newValue;
      }
    }
  };

  await updatePackageScript('start', 'electron-forge start');
  await updatePackageScript('package', 'electron-forge package');
  await updatePackageScript('make', 'electron-forge make');
  d('forgified scripts object:', packageJSON.scripts);

  const writeChanges = async () => {
    await (0, _asyncOra.asyncOra)('Writing modified package.json file', async () => {
      await _fsExtra.default.writeJson(_path.default.resolve(dir, 'package.json'), packageJSON, {
        spaces: 2
      });
    });
  };

  await writeChanges();
  await (0, _asyncOra.asyncOra)('Installing dependencies', async () => {
    d('deleting old dependencies forcefully');
    await _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron'));
    await _fsExtra.default.remove(_path.default.resolve(dir, 'node_modules/.bin/electron.cmd'));
    d('installing dependencies');
    await (0, _installDependencies.default)(dir, importDeps);
    d('installing devDependencies');
    await (0, _installDependencies.default)(dir, importDevDeps, _installDependencies.DepType.DEV);
    d('installing exactDevDependencies');
    await (0, _installDependencies.default)(dir, importExactDevDeps, _installDependencies.DepType.DEV, _installDependencies.DepVersionRestriction.EXACT);
  });
  packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);

  if (!packageJSON.version) {
    (0, _messages.warn)(interactive, 'Please set the "version" in your application\'s package.json'.yellow);
  }

  packageJSON.config = packageJSON.config || {};
  const templatePackageJSON = await (0, _readPackageJson.readRawPackageJson)(_templateBase.default.templateDir);

  if (packageJSON.config.forge) {
    if (typeof packageJSON.config.forge !== 'string') {
      packageJSON.config.forge = (0, _lodash.merge)(templatePackageJSON.config.forge, packageJSON.config.forge);
    }
  } else {
    packageJSON.config.forge = templatePackageJSON.config.forge;
  }

  if (typeof packageJSON.config.forge !== 'string') {
    (0, _forgeConfig.setInitialForgeConfig)(packageJSON);
  }

  await writeChanges();
  await (0, _asyncOra.asyncOra)('Fixing .gitignore', async () => {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, '.gitignore'))) {
      const gitignore = await _fsExtra.default.readFile(_path.default.resolve(dir, '.gitignore'));

      if (!gitignore.includes(calculatedOutDir)) {
        await _fsExtra.default.writeFile(_path.default.resolve(dir, '.gitignore'), `${gitignore}\n${calculatedOutDir}/`);
      }
    }
  });
  (0, _messages.info)(interactive, `

We have ATTEMPTED to convert your app to be in a format that electron-forge understands.

Thanks for using ${'"electron-forge"'.green}!!!`);
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvaW1wb3J0LnRzIl0sIm5hbWVzIjpbImQiLCJkaXIiLCJwcm9jZXNzIiwiY3dkIiwiaW50ZXJhY3RpdmUiLCJjb25maXJtSW1wb3J0Iiwic2hvdWxkQ29udGludWVPbkV4aXN0aW5nIiwic2hvdWxkUmVtb3ZlRGVwZW5kZW5jeSIsInNob3VsZFVwZGF0ZVNjcmlwdCIsIm91dERpciIsImNhbGN1bGF0ZWRPdXREaXIiLCJhc3luY09yYSIsImZzIiwicGF0aEV4aXN0cyIsInBhdGgiLCJyZXNvbHZlIiwiRXJyb3IiLCJleGl0IiwiaW1wb3J0RGVwcyIsImNvbmNhdCIsImRlcHMiLCJpbXBvcnREZXZEZXBzIiwiZGV2RGVwcyIsImltcG9ydEV4YWN0RGV2RGVwcyIsImV4YWN0RGV2RGVwcyIsInBhY2thZ2VKU09OIiwiY29uZmlnIiwiZm9yZ2UiLCJtYWtlcnMiLCJncmVlbiIsInllbGxvdyIsImRlcGVuZGVuY2llcyIsImRldkRlcGVuZGVuY2llcyIsImtleXMiLCJPYmplY3QiLCJidWlsZFRvb2xQYWNrYWdlcyIsImtleSIsImV4cGxhbmF0aW9uIiwicmVtb3ZlIiwic2NyaXB0cyIsInVwZGF0ZVBhY2thZ2VTY3JpcHQiLCJzY3JpcHROYW1lIiwibmV3VmFsdWUiLCJ1cGRhdGUiLCJ3cml0ZUNoYW5nZXMiLCJ3cml0ZUpzb24iLCJzcGFjZXMiLCJEZXBUeXBlIiwiREVWIiwiRGVwVmVyc2lvblJlc3RyaWN0aW9uIiwiRVhBQ1QiLCJ2ZXJzaW9uIiwidGVtcGxhdGVQYWNrYWdlSlNPTiIsImJhc2VUZW1wbGF0ZSIsInRlbXBsYXRlRGlyIiwiZ2l0aWdub3JlIiwicmVhZEZpbGUiLCJpbmNsdWRlcyIsIndyaXRlRmlsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsTUFB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TUFJTztBQUNMRixJQUFBQSxXQUFXLENBQUNDLE1BQVosQ0FBbUJDLEtBQW5CLEdBQTJCeUIsbUJBQW1CLENBQUMxQixNQUFwQixDQUEyQkMsS0FBdEQ7QUFDRDs7QUFFRCxNQUFJLE9BQU9GLFdBQVcsQ0FBQ0MsTUFBWixDQUFtQkMsS0FBMUIsS0FBb0MsUUFBeEMsRUFBa0Q7QUFDaEQsNENBQXNCRixXQUF0QjtBQUNEOztBQUVELFFBQU1tQixZQUFZLEVBQWxCO0FBRUEsUUFBTSx3QkFBUyxtQkFBVCxFQUE4QixZQUFZO0FBQzlDLFFBQUksTUFBTWhDLGlCQUFHQyxVQUFILENBQWNDLGNBQUtDLE9BQUwsQ0FBYWQsR0FBYixFQUFrQixZQUFsQixDQUFkLENBQVYsRUFBMEQ7QUFDeEQsWUFBTXNELFNBQVMsR0FBRyxNQUFNM0MsaUJBQUc0QyxRQUFILENBQVkxQyxjQUFLQyxPQUFMLENBQWFkLEdBQWIsRUFBa0IsWUFBbEIsQ0FBWixDQUF4Qjs7QUFDQSxVQUFJLENBQUNzRCxTQUFTLENBQUNFLFFBQVYsQ0FBbUIvQyxnQkFBbkIsQ0FBTCxFQUEyQztBQUN6QyxjQUFNRSxpQkFBRzhDLFNBQUgsQ0FBYTVDLGNBQUtDLE9BQUwsQ0FBYWQsR0FBYixFQUFrQixZQUFsQixDQUFiLEVBQStDLEdBQUVzRCxTQUFVLEtBQUk3QyxnQkFBaUIsR0FBaEYsQ0FBTjtBQUNEO0FBQ0Y7QUFDRixHQVBLLENBQU47QUFTQSxzQkFBS04sV0FBTCxFQUFtQjs7OzttQkFJRixtQkFBbUJ5QixLQUFNLEtBSjFDO0FBS0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1lcmdlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgYmFzZVRlbXBsYXRlIGZyb20gJ0BlbGVjdHJvbi1mb3JnZS90ZW1wbGF0ZS1iYXNlJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCBpbml0R2l0IGZyb20gJy4vaW5pdC1zY3JpcHRzL2luaXQtZ2l0JztcbmltcG9ydCB7IGRlcHMsIGRldkRlcHMsIGV4YWN0RGV2RGVwcyB9IGZyb20gJy4vaW5pdC1zY3JpcHRzL2luaXQtbnBtJztcblxuaW1wb3J0IHsgdXBkYXRlRWxlY3Ryb25EZXBlbmRlbmN5IH0gZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi12ZXJzaW9uJztcbmltcG9ydCB7IHNldEluaXRpYWxGb3JnZUNvbmZpZyB9IGZyb20gJy4uL3V0aWwvZm9yZ2UtY29uZmlnJztcbmltcG9ydCB7IGluZm8sIHdhcm4gfSBmcm9tICcuLi91dGlsL21lc3NhZ2VzJztcbmltcG9ydCBpbnN0YWxsRGVwTGlzdCwgeyBEZXBUeXBlLCBEZXBWZXJzaW9uUmVzdHJpY3Rpb24gfSBmcm9tICcuLi91dGlsL2luc3RhbGwtZGVwZW5kZW5jaWVzJztcbmltcG9ydCB7IHJlYWRSYXdQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHVwZ3JhZGVGb3JnZUNvbmZpZywgeyB1cGRhdGVVcGdyYWRlZEZvcmdlRGV2RGVwcyB9IGZyb20gJy4uL3V0aWwvdXBncmFkZS1mb3JnZS1jb25maWcnO1xuXG5jb25zdCBkID0gZGVidWcoJ2VsZWN0cm9uLWZvcmdlOmltcG9ydCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEltcG9ydE9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGFwcCB0byBiZSBpbXBvcnRlZFxuICAgKi9cbiAgZGlyPzogc3RyaW5nO1xuICAvKipcbiAgICogV2hldGhlciB0byB1c2Ugc2Vuc2libGUgZGVmYXVsdHMgb3IgcHJvbXB0IHRoZSB1c2VyIHZpc3VhbGx5XG4gICAqL1xuICBpbnRlcmFjdGl2ZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBBbiBhc3luYyBmdW5jdGlvbiB0aGF0IHJldHVybnMgdHJ1ZSBvciBmYWxzZSBpbiBvcmRlciB0byBjb25maXJtIHRoZSBzdGFydFxuICAgKiBvZiBpbXBvcnRpbmdcbiAgICovXG4gIGNvbmZpcm1JbXBvcnQ/OiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+O1xuICAvKipcbiAgICogQW4gYXN5bmMgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHdoZXRoZXIgdGhlIGltcG9ydCBzaG91bGQgY29udGludWUgaWYgaXRcbiAgICogbG9va3MgbGlrZSBhIGZvcmdlIHByb2plY3QgYWxyZWFkeVxuICAgKi9cbiAgc2hvdWxkQ29udGludWVPbkV4aXN0aW5nPzogKCkgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIEFuIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB3aGV0aGVyIHRoZSBnaXZlbiBkZXBlbmRlbmN5IHNob3VsZCBiZSByZW1vdmVkXG4gICAqL1xuICBzaG91bGRSZW1vdmVEZXBlbmRlbmN5PzogKGRlcGVuZGVuY3k6IHN0cmluZywgZXhwbGFuYXRpb246IHN0cmluZykgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIEFuIGFzeW5jIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB3aGV0aGVyIHRoZSBnaXZlbiBzY3JpcHQgc2hvdWxkIGJlIG92ZXJyaWRkZW4gd2l0aCBhIGZvcmdlIG9uZVxuICAgKi9cbiAgc2hvdWxkVXBkYXRlU2NyaXB0PzogKHNjcmlwdE5hbWU6IHN0cmluZywgbmV3VmFsdWU6IHN0cmluZykgPT4gUHJvbWlzZTxib29sZWFuPjtcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBkaXJlY3RvcnkgY29udGFpbmluZyBnZW5lcmF0ZWQgZGlzdHJpYnV0YWJsZXNcbiAgICovXG4gIG91dERpcj86IHN0cmluZztcbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKHtcbiAgZGlyID0gcHJvY2Vzcy5jd2QoKSxcbiAgaW50ZXJhY3RpdmUgPSBmYWxzZSxcbiAgY29uZmlybUltcG9ydCxcbiAgc2hvdWxkQ29udGludWVPbkV4aXN0aW5nLFxuICBzaG91bGRSZW1vdmVEZXBlbmRlbmN5LFxuICBzaG91bGRVcGRhdGVTY3JpcHQsXG4gIG91dERpcixcbn06IEltcG9ydE9wdGlvbnMpID0+IHtcbiAgY29uc3QgY2FsY3VsYXRlZE91dERpciA9IG91dERpciB8fCAnb3V0JztcbiAgYXN5bmNPcmEuaW50ZXJhY3RpdmUgPSBpbnRlcmFjdGl2ZTtcblxuICBkKGBBdHRlbXB0aW5nIHRvIGltcG9ydCBwcm9qZWN0IGluOiAke2Rpcn1gKTtcbiAgaWYgKCFhd2FpdCBmcy5wYXRoRXhpc3RzKGRpcikgfHwgIWF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGRpciwgJ3BhY2thZ2UuanNvbicpKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgV2UgY291bGRuJ3QgZmluZCBhIHByb2plY3QgaW46ICR7ZGlyfWApO1xuICB9XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgaWYgKHR5cGVvZiBjb25maXJtSW1wb3J0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgaWYgKCFhd2FpdCBjb25maXJtSW1wb3J0KCkpIHtcbiAgICAgIHByb2Nlc3MuZXhpdCgwKTtcbiAgICB9XG4gIH1cblxuICBhd2FpdCBpbml0R2l0KGRpcik7XG5cbiAgY29uc3QgaW1wb3J0RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGRlcHMpO1xuICBsZXQgaW1wb3J0RGV2RGVwcyA9IChbXSBhcyBzdHJpbmdbXSkuY29uY2F0KGRldkRlcHMpO1xuICBsZXQgaW1wb3J0RXhhY3REZXZEZXBzID0gKFtdIGFzIHN0cmluZ1tdKS5jb25jYXQoZXhhY3REZXZEZXBzKTtcblxuICBsZXQgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkUmF3UGFja2FnZUpzb24oZGlyKTtcbiAgaWYgKHBhY2thZ2VKU09OLmNvbmZpZyAmJiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpIHtcbiAgICBpZiAocGFja2FnZUpTT04uY29uZmlnLmZvcmdlLm1ha2Vycykge1xuICAgICAgd2FybihpbnRlcmFjdGl2ZSwgJ0l0IGxvb2tzIGxpa2UgdGhpcyBwcm9qZWN0IGlzIGFscmVhZHkgY29uZmlndXJlZCBmb3IgRWxlY3Ryb24gRm9yZ2UnLmdyZWVuKTtcbiAgICAgIGlmICh0eXBlb2Ygc2hvdWxkQ29udGludWVPbkV4aXN0aW5nID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGlmICghYXdhaXQgc2hvdWxkQ29udGludWVPbkV4aXN0aW5nKCkpIHtcbiAgICAgICAgICBwcm9jZXNzLmV4aXQoMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICB3YXJuKGludGVyYWN0aXZlLCBcIldlIGNhbid0IHRlbGwgaWYgdGhlIEVsZWN0cm9uIEZvcmdlIGNvbmZpZyBpcyBjb21wYXRpYmxlIGJlY2F1c2UgaXQncyBpbiBhbiBleHRlcm5hbCBKYXZhU2NyaXB0IGZpbGUsIG5vdCB0cnlpbmcgdG8gY29udmVydCBpdCBhbmQgY29udGludWluZyBhbnl3YXlcIi55ZWxsb3cpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkKCdVcGdyYWRpbmcgYW4gRWxlY3Ryb24gRm9yZ2UgPCA2IHByb2plY3QnKTtcbiAgICAgIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSA9IHVwZ3JhZGVGb3JnZUNvbmZpZyhwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpO1xuICAgICAgaW1wb3J0RGV2RGVwcyA9IHVwZGF0ZVVwZ3JhZGVkRm9yZ2VEZXZEZXBzKHBhY2thZ2VKU09OLCBpbXBvcnREZXZEZXBzKTtcbiAgICB9XG4gIH1cblxuICBwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXMgPSBwYWNrYWdlSlNPTi5kZXBlbmRlbmNpZXMgfHwge307XG4gIHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcyA9IHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcyB8fCB7fTtcblxuICBbaW1wb3J0RGV2RGVwcywgaW1wb3J0RXhhY3REZXZEZXBzXSA9IHVwZGF0ZUVsZWN0cm9uRGVwZW5kZW5jeShcbiAgICBwYWNrYWdlSlNPTixcbiAgICBpbXBvcnREZXZEZXBzLFxuICAgIGltcG9ydEV4YWN0RGV2RGVwcyxcbiAgKTtcblxuICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGVwZW5kZW5jaWVzKVxuICAgIC5jb25jYXQoT2JqZWN0LmtleXMocGFja2FnZUpTT04uZGV2RGVwZW5kZW5jaWVzKSk7XG4gIGNvbnN0IGJ1aWxkVG9vbFBhY2thZ2VzOiB7XG4gICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICB9ID0ge1xuICAgICdAZWxlY3Ryb24vZ2V0JzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLWJ1aWxkZXInOiAncHJvdmlkZXMgbW9zdGx5IGVxdWl2YWxlbnQgZnVuY3Rpb25hbGl0eScsXG4gICAgJ2VsZWN0cm9uLWRvd25sb2FkJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLWZvcmdlJzogJ3JlcGxhY2VkIHdpdGggQGVsZWN0cm9uLWZvcmdlL2NsaScsXG4gICAgJ2VsZWN0cm9uLWluc3RhbGxlci1kZWJpYW4nOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgICAnZWxlY3Ryb24taW5zdGFsbGVyLWRtZyc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1pbnN0YWxsZXItZmxhdHBhayc6ICdhbHJlYWR5IHVzZXMgdGhpcyBtb2R1bGUgYXMgYSB0cmFuc2l0aXZlIGRlcGVuZGVuY3knLFxuICAgICdlbGVjdHJvbi1pbnN0YWxsZXItcmVkaGF0JzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLW9zeC1zaWduJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLXBhY2thZ2VyJzogJ2FscmVhZHkgdXNlcyB0aGlzIG1vZHVsZSBhcyBhIHRyYW5zaXRpdmUgZGVwZW5kZW5jeScsXG4gICAgJ2VsZWN0cm9uLXdpbnN0YWxsZXInOiAnYWxyZWFkeSB1c2VzIHRoaXMgbW9kdWxlIGFzIGEgdHJhbnNpdGl2ZSBkZXBlbmRlbmN5JyxcbiAgfTtcblxuICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgaWYgKGJ1aWxkVG9vbFBhY2thZ2VzW2tleV0pIHtcbiAgICAgIGNvbnN0IGV4cGxhbmF0aW9uID0gYnVpbGRUb29sUGFja2FnZXNba2V5XSE7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgICAgbGV0IHJlbW92ZSA9IHRydWU7XG4gICAgICBpZiAodHlwZW9mIHNob3VsZFJlbW92ZURlcGVuZGVuY3kgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcmVtb3ZlID0gYXdhaXQgc2hvdWxkUmVtb3ZlRGVwZW5kZW5jeShrZXksIGV4cGxhbmF0aW9uKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlbW92ZSkge1xuICAgICAgICBkZWxldGUgcGFja2FnZUpTT04uZGVwZW5kZW5jaWVzW2tleV07XG4gICAgICAgIGRlbGV0ZSBwYWNrYWdlSlNPTi5kZXZEZXBlbmRlbmNpZXNba2V5XTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwYWNrYWdlSlNPTi5zY3JpcHRzID0gcGFja2FnZUpTT04uc2NyaXB0cyB8fCB7fTtcbiAgZCgncmVhZGluZyBjdXJyZW50IHNjcmlwdHMgb2JqZWN0OicsIHBhY2thZ2VKU09OLnNjcmlwdHMpO1xuXG4gIGNvbnN0IHVwZGF0ZVBhY2thZ2VTY3JpcHQgPSBhc3luYyAoc2NyaXB0TmFtZTogc3RyaW5nLCBuZXdWYWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgaWYgKHBhY2thZ2VKU09OLnNjcmlwdHNbc2NyaXB0TmFtZV0gIT09IG5ld1ZhbHVlKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWxlblxuICAgICAgbGV0IHVwZGF0ZSA9IHRydWU7XG4gICAgICBpZiAodHlwZW9mIHNob3VsZFVwZGF0ZVNjcmlwdCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICB1cGRhdGUgPSBhd2FpdCBzaG91bGRVcGRhdGVTY3JpcHQoc2NyaXB0TmFtZSwgbmV3VmFsdWUpO1xuICAgICAgfVxuICAgICAgaWYgKHVwZGF0ZSkge1xuICAgICAgICBwYWNrYWdlSlNPTi5zY3JpcHRzW3NjcmlwdE5hbWVdID0gbmV3VmFsdWU7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGF3YWl0IHVwZGF0ZVBhY2thZ2VTY3JpcHQoJ3N0YXJ0JywgJ2VsZWN0cm9uLWZvcmdlIHN0YXJ0Jyk7XG4gIGF3YWl0IHVwZGF0ZVBhY2thZ2VTY3JpcHQoJ3BhY2thZ2UnLCAnZWxlY3Ryb24tZm9yZ2UgcGFja2FnZScpO1xuICBhd2FpdCB1cGRhdGVQYWNrYWdlU2NyaXB0KCdtYWtlJywgJ2VsZWN0cm9uLWZvcmdlIG1ha2UnKTtcblxuICBkKCdmb3JnaWZpZWQgc2NyaXB0cyBvYmplY3Q6JywgcGFja2FnZUpTT04uc2NyaXB0cyk7XG5cbiAgY29uc3Qgd3JpdGVDaGFuZ2VzID0gYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGFzeW5jT3JhKCdXcml0aW5nIG1vZGlmaWVkIHBhY2thZ2UuanNvbiBmaWxlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgZnMud3JpdGVKc29uKHBhdGgucmVzb2x2ZShkaXIsICdwYWNrYWdlLmpzb24nKSwgcGFja2FnZUpTT04sIHsgc3BhY2VzOiAyIH0pO1xuICAgIH0pO1xuICB9O1xuXG4gIGF3YWl0IHdyaXRlQ2hhbmdlcygpO1xuXG4gIGF3YWl0IGFzeW5jT3JhKCdJbnN0YWxsaW5nIGRlcGVuZGVuY2llcycsIGFzeW5jICgpID0+IHtcbiAgICBkKCdkZWxldGluZyBvbGQgZGVwZW5kZW5jaWVzIGZvcmNlZnVsbHknKTtcbiAgICBhd2FpdCBmcy5yZW1vdmUocGF0aC5yZXNvbHZlKGRpciwgJ25vZGVfbW9kdWxlcy8uYmluL2VsZWN0cm9uJykpO1xuICAgIGF3YWl0IGZzLnJlbW92ZShwYXRoLnJlc29sdmUoZGlyLCAnbm9kZV9tb2R1bGVzLy5iaW4vZWxlY3Ryb24uY21kJykpO1xuXG4gICAgZCgnaW5zdGFsbGluZyBkZXBlbmRlbmNpZXMnKTtcbiAgICBhd2FpdCBpbnN0YWxsRGVwTGlzdChkaXIsIGltcG9ydERlcHMpO1xuXG4gICAgZCgnaW5zdGFsbGluZyBkZXZEZXBlbmRlbmNpZXMnKTtcbiAgICBhd2FpdCBpbnN0YWxsRGVwTGlzdChkaXIsIGltcG9ydERldkRlcHMsIERlcFR5cGUuREVWKTtcblxuICAgIGQoJ2luc3RhbGxpbmcgZXhhY3REZXZEZXBlbmRlbmNpZXMnKTtcbiAgICBhd2FpdCBpbnN0YWxsRGVwTGlzdChkaXIsIGltcG9ydEV4YWN0RGV2RGVwcywgRGVwVHlwZS5ERVYsIERlcFZlcnNpb25SZXN0cmljdGlvbi5FWEFDVCk7XG4gIH0pO1xuXG4gIHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZFJhd1BhY2thZ2VKc29uKGRpcik7XG5cbiAgaWYgKCFwYWNrYWdlSlNPTi52ZXJzaW9uKSB7XG4gICAgd2FybihpbnRlcmFjdGl2ZSwgJ1BsZWFzZSBzZXQgdGhlIFwidmVyc2lvblwiIGluIHlvdXIgYXBwbGljYXRpb25cXCdzIHBhY2thZ2UuanNvbicueWVsbG93KTtcbiAgfVxuXG4gIHBhY2thZ2VKU09OLmNvbmZpZyA9IHBhY2thZ2VKU09OLmNvbmZpZyB8fCB7fTtcbiAgY29uc3QgdGVtcGxhdGVQYWNrYWdlSlNPTiA9IGF3YWl0IHJlYWRSYXdQYWNrYWdlSnNvbihiYXNlVGVtcGxhdGUudGVtcGxhdGVEaXIpO1xuICBpZiAocGFja2FnZUpTT04uY29uZmlnLmZvcmdlKSB7XG4gICAgaWYgKHR5cGVvZiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgIT09ICdzdHJpbmcnKSB7XG4gICAgICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgPSBtZXJnZSh0ZW1wbGF0ZVBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSwgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcGFja2FnZUpTT04uY29uZmlnLmZvcmdlID0gdGVtcGxhdGVQYWNrYWdlSlNPTi5jb25maWcuZm9yZ2U7XG4gIH1cblxuICBpZiAodHlwZW9mIHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZSAhPT0gJ3N0cmluZycpIHtcbiAgICBzZXRJbml0aWFsRm9yZ2VDb25maWcocGFja2FnZUpTT04pO1xuICB9XG5cbiAgYXdhaXQgd3JpdGVDaGFuZ2VzKCk7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0ZpeGluZyAuZ2l0aWdub3JlJywgYXN5bmMgKCkgPT4ge1xuICAgIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsICcuZ2l0aWdub3JlJykpKSB7XG4gICAgICBjb25zdCBnaXRpZ25vcmUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpKTtcbiAgICAgIGlmICghZ2l0aWdub3JlLmluY2x1ZGVzKGNhbGN1bGF0ZWRPdXREaXIpKSB7XG4gICAgICAgIGF3YWl0IGZzLndyaXRlRmlsZShwYXRoLnJlc29sdmUoZGlyLCAnLmdpdGlnbm9yZScpLCBgJHtnaXRpZ25vcmV9XFxuJHtjYWxjdWxhdGVkT3V0RGlyfS9gKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGluZm8oaW50ZXJhY3RpdmUsIGBcblxuV2UgaGF2ZSBBVFRFTVBURUQgdG8gY29udmVydCB5b3VyIGFwcCB0byBiZSBpbiBhIGZvcm1hdCB0aGF0IGVsZWN0cm9uLWZvcmdlIHVuZGVyc3RhbmRzLlxuXG5UaGFua3MgZm9yIHVzaW5nICR7J1wiZWxlY3Ryb24tZm9yZ2VcIicuZ3JlZW59ISEhYCk7XG59O1xuIl19