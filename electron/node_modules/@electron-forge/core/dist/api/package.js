"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _get = require("@electron/get");

var _glob = _interopRequireDefault(require("glob"));

var _electronPackager = _interopRequireDefault(require("electron-packager"));

var _path = _interopRequireDefault(require("path"));

var _util = require("util");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _hook = require("../util/hook");

var _messages = require("../util/messages");

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _requireSearch = _interopRequireDefault(require("../util/require-search"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _outDir = _interopRequireDefault(require("../util/out-dir"));

var _electronVersion = require("../util/electron-version");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:packager');

/**
 * Resolves hooks if they are a path to a file (instead of a `Function`).
 */
function resolveHooks(hooks, dir) {
  if (hooks) {
    return hooks.map(hook => typeof hook === 'string' ? (0, _requireSearch.default)(dir, [hook]) : hook);
  }

  return [];
}
/**
 * Runs given hooks sequentially by mapping them to promises and iterating
 * through while awaiting
 */


function sequentialHooks(hooks) {
  return [async (...args) => {
    const done = args[args.length - 1];
    const passedArgs = args.splice(0, args.length - 1);

    for (const hook of hooks) {
      await (0, _util.promisify)(hook)(...passedArgs);
    }

    done();
  }];
}

var _default = async ({
  dir = process.cwd(),
  interactive = false,
  arch = (0, _get.getHostArch)(),
  platform = process.platform,
  outDir
}) => {
  const ora = interactive ? _asyncOra.ora : _asyncOra.fakeOra;
  let prepareSpinner = ora(`Preparing to Package Application for arch: ${(arch === 'all' ? 'ia32' : arch).cyan}`).start();
  let prepareCounter = 0;
  const resolvedDir = await (0, _resolveDir.default)(dir);

  if (!resolvedDir) {
    throw new Error('Failed to locate compilable Electron application');
  }

  dir = resolvedDir;
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.main) {
    throw new Error('packageJSON.main must be set to a valid entry point for your Electron app');
  }

  const calculatedOutDir = outDir || (0, _outDir.default)(dir, forgeConfig);
  let packagerSpinner = null;
  const pruneEnabled = !('prune' in forgeConfig.packagerConfig) || forgeConfig.packagerConfig.prune;
  const afterCopyHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    if (packagerSpinner) {
      packagerSpinner.succeed();
      prepareCounter += 1;
      prepareSpinner = ora(`Preparing to Package Application for arch: ${(prepareCounter === 2 ? 'armv7l' : 'x64').cyan}`).start();
    }

    const bins = await (0, _util.promisify)(_glob.default)(_path.default.join(buildPath, '**/.bin/**/*'));

    for (const bin of bins) {
      await _fsExtra.default.remove(bin);
    }

    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    prepareSpinner.succeed();
    await (0, _hook.runHook)(forgeConfig, 'packageAfterCopy', buildPath, electronVersion, pPlatform, pArch);
    done();
  }, async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _rebuild.default)(buildPath, electronVersion, pPlatform, pArch, forgeConfig.electronRebuildConfig);
    packagerSpinner = ora('Packaging Application').start();
    done();
  }];
  afterCopyHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    const copiedPackageJSON = await (0, _readPackageJson.readMutatedPackageJson)(buildPath, forgeConfig);

    if (copiedPackageJSON.config && copiedPackageJSON.config.forge) {
      delete copiedPackageJSON.config.forge;
    }

    await _fsExtra.default.writeJson(_path.default.resolve(buildPath, 'package.json'), copiedPackageJSON, {
      spaces: 2
    });
    done();
  });
  afterCopyHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterCopy, dir));
  const afterPruneHooks = [];

  if (pruneEnabled) {
    afterPruneHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterPrune, dir));
  }

  afterPruneHooks.push(async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterPrune', buildPath, electronVersion, pPlatform, pArch);
    done();
  });
  const afterExtractHooks = [async (buildPath, electronVersion, pPlatform, pArch, done) => {
    await (0, _hook.runHook)(forgeConfig, 'packageAfterExtract', buildPath, electronVersion, pPlatform, pArch);
    done();
  }];
  afterExtractHooks.push(...resolveHooks(forgeConfig.packagerConfig.afterExtract, dir));
  const packageOpts = {
    asar: false,
    overwrite: true,
    ...forgeConfig.packagerConfig,
    dir,
    arch: arch,
    platform,
    afterCopy: sequentialHooks(afterCopyHooks),
    afterExtract: sequentialHooks(afterExtractHooks),
    afterPrune: sequentialHooks(afterPruneHooks),
    out: calculatedOutDir,
    electronVersion: await (0, _electronVersion.getElectronVersion)(dir, packageJSON)
  };
  packageOpts.quiet = true;

  if (packageOpts.all) {
    throw new Error('config.forge.packagerConfig.all is not supported by Electron Forge');
  }

  if (!packageJSON.version && !packageOpts.appVersion) {
    // eslint-disable-next-line max-len
    (0, _messages.warn)(interactive, 'Please set "version" or "config.forge.packagerConfig.appVersion" in your application\'s package.json so auto-updates work properly'.yellow);
  }

  if (packageOpts.prebuiltAsar) {
    throw new Error('config.forge.packagerConfig.prebuiltAsar is not supported by Electron Forge');
  }

  await (0, _hook.runHook)(forgeConfig, 'generateAssets');
  await (0, _hook.runHook)(forgeConfig, 'prePackage');
  d('packaging with options', packageOpts);
  await (0, _electronPackager.default)(packageOpts);
  await (0, _hook.runHook)(forgeConfig, 'postPackage');
  if (packagerSpinner) packagerSpinner.succeed();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvcGFja2FnZS50cyJdLCJuYW1lcyI6WyJkIiwicmVzb2x2ZUhvb2tzIiwiaG9va3MiLCJkaXIiLCJtYXAiLCJob29rIiwic2VxdWVudGlhbEhvb2tzIiwiYXJncyIsImRvbmUiLCJsZW5ndGgiLCJwYXNzZWRBcmdzIiwic3BsaWNlIiwicHJvY2VzcyIsImN3ZCIsImludGVyYWN0aXZlIiwiYXJjaCIsInBsYXRmb3JtIiwib3V0RGlyIiwib3JhIiwicmVhbE9yYSIsImZha2VPcmEiLCJwcmVwYXJlU3Bpbm5lciIsImN5YW4iLCJzdGFydCIsInByZXBhcmVDb3VudGVyIiwicmVzb2x2ZWREaXIiLCJFcnJvciIsImZvcmdlQ29uZmlnIiwicGFja2FnZUpTT04iLCJtYWluIiwiY2FsY3VsYXRlZE91dERpciIsInBhY2thZ2VyU3Bpbm5lciIsInBydW5lRW5hYmxlZCIsInBhY2thZ2VyQ29uZmlnIiwicHJ1bmUiLCJhZnRlckNvcHlIb29rcyIsImJ1aWxkUGF0aCIsImVsZWN0cm9uVmVyc2lvbiIsInBQbGF0Zm9ybSIsInBBcmNoIiwic3VjY2VlZCIsImJpbnMiLCJnbG9iIiwicGF0aCIsImpvaW4iLCJiaW4iLCJmcyIsInJlbW92ZSIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsInB1c2giLCJjb3BpZWRQYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwid3JpdGVKc29uIiwicmVzb2x2ZSIsInNwYWNlcyIsImFmdGVyQ29weSIsImFmdGVyUHJ1bmVIb29rcyIsImFmdGVyUHJ1bmUiLCJhZnRlckV4dHJhY3RIb29rcyIsImFmdGVyRXh0cmFjdCIsInBhY2thZ2VPcHRzIiwiYXNhciIsIm92ZXJ3cml0ZSIsIm91dCIsInF1aWV0IiwiYWxsIiwidmVyc2lvbiIsImFwcFZlcnNpb24iLCJ5ZWxsb3ciLCJwcmVidWlsdEFzYXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNB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QUNOLFdBQVcsQ0FBQ08sVUFBekMsRUFBcUQ7QUFDbkQ7QUFDQSx3QkFBS3RELFdBQUwsRUFBa0IscUlBQXFJdUQsTUFBdko7QUFDRDs7QUFFRCxNQUFJUixXQUFXLENBQUNTLFlBQWhCLEVBQThCO0FBQzVCLFVBQU0sSUFBSTVDLEtBQUosQ0FBVSw2RUFBVixDQUFOO0FBQ0Q7O0FBRUQsUUFBTSxtQkFBUUMsV0FBUixFQUFxQixnQkFBckIsQ0FBTjtBQUNBLFFBQU0sbUJBQVFBLFdBQVIsRUFBcUIsWUFBckIsQ0FBTjtBQUVBM0IsRUFBQUEsQ0FBQyxDQUFDLHdCQUFELEVBQTJCNkQsV0FBM0IsQ0FBRDtBQUVBLFFBQU0sK0JBQVNBLFdBQVQsQ0FBTjtBQUVBLFFBQU0sbUJBQVFsQyxXQUFSLEVBQXFCLGFBQXJCLENBQU47QUFFQSxNQUFJSSxlQUFKLEVBQXFCQSxlQUFlLENBQUVTLE9BQWpCO0FBQ3RCLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2NvbG9ycyc7XG5pbXBvcnQgeyBvcmEgYXMgcmVhbE9yYSwgZmFrZU9yYSwgT3JhSW1wbCB9IGZyb20gJ0BlbGVjdHJvbi1mb3JnZS9hc3luYy1vcmEnO1xuaW1wb3J0IHsgRm9yZ2VBcmNoLCBGb3JnZVBsYXRmb3JtIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IGdldEhvc3RBcmNoIH0gZnJvbSAnQGVsZWN0cm9uL2dldCc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBwYWNrYWdlciBmcm9tICdlbGVjdHJvbi1wYWNrYWdlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xuXG5pbXBvcnQgZ2V0Rm9yZ2VDb25maWcgZnJvbSAnLi4vdXRpbC9mb3JnZS1jb25maWcnO1xuaW1wb3J0IHsgcnVuSG9vayB9IGZyb20gJy4uL3V0aWwvaG9vayc7XG5pbXBvcnQgeyB3YXJuIH0gZnJvbSAnLi4vdXRpbC9tZXNzYWdlcyc7XG5pbXBvcnQgeyByZWFkTXV0YXRlZFBhY2thZ2VKc29uIH0gZnJvbSAnLi4vdXRpbC9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgcmVidWlsZEhvb2sgZnJvbSAnLi4vdXRpbC9yZWJ1aWxkJztcbmltcG9ydCByZXF1aXJlU2VhcmNoIGZyb20gJy4uL3V0aWwvcmVxdWlyZS1zZWFyY2gnO1xuaW1wb3J0IHJlc29sdmVEaXIgZnJvbSAnLi4vdXRpbC9yZXNvbHZlLWRpcic7XG5pbXBvcnQgZ2V0Q3VycmVudE91dERpciBmcm9tICcuLi91dGlsL291dC1kaXInO1xuaW1wb3J0IHsgZ2V0RWxlY3Ryb25WZXJzaW9uIH0gZnJvbSAnLi4vdXRpbC9lbGVjdHJvbi12ZXJzaW9uJztcblxuY29uc3QgZCA9IGRlYnVnKCdlbGVjdHJvbi1mb3JnZTpwYWNrYWdlcicpO1xuXG50eXBlIEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rID0gKFxuICBidWlsZFBhdGg6IHN0cmluZyxcbiAgZWxlY3Ryb25WZXJzaW9uOiBzdHJpbmcsXG4gIHBQbGF0Zm9ybTogRm9yZ2VQbGF0Zm9ybSxcbiAgcEFyY2g6IEZvcmdlQXJjaCxcbiAgZG9uZTogKGVycj86IEVycm9yKSA9PiB2b2lkXG4pID0+IHZvaWQ7XG5cbi8qKlxuICogUmVzb2x2ZXMgaG9va3MgaWYgdGhleSBhcmUgYSBwYXRoIHRvIGEgZmlsZSAoaW5zdGVhZCBvZiBhIGBGdW5jdGlvbmApLlxuICovXG5mdW5jdGlvbiByZXNvbHZlSG9va3MoaG9va3M6IChzdHJpbmcgfCBFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9vaylbXSB8IHVuZGVmaW5lZCwgZGlyOiBzdHJpbmcpIHtcbiAgaWYgKGhvb2tzKSB7XG4gICAgcmV0dXJuIGhvb2tzLm1hcCgoaG9vaykgPT4gKFxuICAgICAgdHlwZW9mIGhvb2sgPT09ICdzdHJpbmcnXG4gICAgICAgID8gcmVxdWlyZVNlYXJjaDxFbGVjdHJvblBhY2thZ2VyQWZ0ZXJDb3B5SG9vaz4oZGlyLCBbaG9va10pIGFzIEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rXG4gICAgICAgIDogaG9va1xuICAgICkpO1xuICB9XG5cbiAgcmV0dXJuIFtdO1xufVxuXG4vKipcbiAqIFJ1bnMgZ2l2ZW4gaG9va3Mgc2VxdWVudGlhbGx5IGJ5IG1hcHBpbmcgdGhlbSB0byBwcm9taXNlcyBhbmQgaXRlcmF0aW5nXG4gKiB0aHJvdWdoIHdoaWxlIGF3YWl0aW5nXG4gKi9cbmZ1bmN0aW9uIHNlcXVlbnRpYWxIb29rcyhob29rczogRnVuY3Rpb25bXSkge1xuICByZXR1cm4gW2FzeW5jICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgIGNvbnN0IGRvbmUgPSBhcmdzW2FyZ3MubGVuZ3RoIC0gMV07XG4gICAgY29uc3QgcGFzc2VkQXJncyA9IGFyZ3Muc3BsaWNlKDAsIGFyZ3MubGVuZ3RoIC0gMSk7XG4gICAgZm9yIChjb25zdCBob29rIG9mIGhvb2tzKSB7XG4gICAgICBhd2FpdCBwcm9taXNpZnkoaG9vaykoLi4ucGFzc2VkQXJncyk7XG4gICAgfVxuICAgIGRvbmUoKTtcbiAgfV0gYXMgWyguLi5hcmdzOiBhbnlbXSkgPT4gUHJvbWlzZTx2b2lkPl07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFja2FnZU9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGFwcCB0byBwYWNrYWdlXG4gICAqL1xuICBkaXI/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIHVzZSBzZW5zaWJsZSBkZWZhdWx0cyBvciBwcm9tcHQgdGhlIHVzZXIgdmlzdWFsbHlcbiAgICovXG4gIGludGVyYWN0aXZlPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRoZSB0YXJnZXQgYXJjaFxuICAgKi9cbiAgYXJjaD86IEZvcmdlQXJjaDtcbiAgLyoqXG4gICAqIFRoZSB0YXJnZXQgcGxhdGZvcm0uXG4gICAqL1xuICBwbGF0Zm9ybT86IEZvcmdlUGxhdGZvcm07XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgb3V0cHV0IGRpcmVjdG9yeSBmb3IgcGFja2FnZWQgYXBwc1xuICAgKi9cbiAgb3V0RGlyPzogc3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyAoe1xuICBkaXIgPSBwcm9jZXNzLmN3ZCgpLFxuICBpbnRlcmFjdGl2ZSA9IGZhbHNlLFxuICBhcmNoID0gZ2V0SG9zdEFyY2goKSBhcyBGb3JnZUFyY2gsXG4gIHBsYXRmb3JtID0gcHJvY2Vzcy5wbGF0Zm9ybSBhcyBGb3JnZVBsYXRmb3JtLFxuICBvdXREaXIsXG59OiBQYWNrYWdlT3B0aW9ucykgPT4ge1xuICBjb25zdCBvcmEgPSBpbnRlcmFjdGl2ZSA/IHJlYWxPcmEgOiBmYWtlT3JhO1xuXG4gIGxldCBwcmVwYXJlU3Bpbm5lciA9IG9yYShgUHJlcGFyaW5nIHRvIFBhY2thZ2UgQXBwbGljYXRpb24gZm9yIGFyY2g6ICR7KGFyY2ggPT09ICdhbGwnID8gJ2lhMzInIDogYXJjaCkuY3lhbn1gKS5zdGFydCgpO1xuICBsZXQgcHJlcGFyZUNvdW50ZXIgPSAwO1xuXG4gIGNvbnN0IHJlc29sdmVkRGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICBpZiAoIXJlc29sdmVkRGlyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gbG9jYXRlIGNvbXBpbGFibGUgRWxlY3Ryb24gYXBwbGljYXRpb24nKTtcbiAgfVxuICBkaXIgPSByZXNvbHZlZERpcjtcblxuICBjb25zdCBmb3JnZUNvbmZpZyA9IGF3YWl0IGdldEZvcmdlQ29uZmlnKGRpcik7XG4gIGNvbnN0IHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbihkaXIsIGZvcmdlQ29uZmlnKTtcblxuICBpZiAoIXBhY2thZ2VKU09OLm1haW4pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3BhY2thZ2VKU09OLm1haW4gbXVzdCBiZSBzZXQgdG8gYSB2YWxpZCBlbnRyeSBwb2ludCBmb3IgeW91ciBFbGVjdHJvbiBhcHAnKTtcbiAgfVxuXG4gIGNvbnN0IGNhbGN1bGF0ZWRPdXREaXIgPSBvdXREaXIgfHwgZ2V0Q3VycmVudE91dERpcihkaXIsIGZvcmdlQ29uZmlnKTtcbiAgbGV0IHBhY2thZ2VyU3Bpbm5lcjogT3JhSW1wbCB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0IHBydW5lRW5hYmxlZCA9ICEoJ3BydW5lJyBpbiBmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZykgfHwgZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcucHJ1bmU7XG5cbiAgY29uc3QgYWZ0ZXJDb3B5SG9va3M6IEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rW10gPSBbXG4gICAgYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgICBpZiAocGFja2FnZXJTcGlubmVyKSB7XG4gICAgICAgIHBhY2thZ2VyU3Bpbm5lci5zdWNjZWVkKCk7XG4gICAgICAgIHByZXBhcmVDb3VudGVyICs9IDE7XG4gICAgICAgIHByZXBhcmVTcGlubmVyID0gb3JhKGBQcmVwYXJpbmcgdG8gUGFja2FnZSBBcHBsaWNhdGlvbiBmb3IgYXJjaDogJHsocHJlcGFyZUNvdW50ZXIgPT09IDIgPyAnYXJtdjdsJyA6ICd4NjQnKS5jeWFufWApLnN0YXJ0KCk7XG4gICAgICB9XG4gICAgICBjb25zdCBiaW5zID0gYXdhaXQgcHJvbWlzaWZ5KGdsb2IpKHBhdGguam9pbihidWlsZFBhdGgsICcqKi8uYmluLyoqLyonKSk7XG4gICAgICBmb3IgKGNvbnN0IGJpbiBvZiBiaW5zKSB7XG4gICAgICAgIGF3YWl0IGZzLnJlbW92ZShiaW4pO1xuICAgICAgfVxuICAgICAgZG9uZSgpO1xuICAgIH0sIGFzeW5jIChidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCwgZG9uZSkgPT4ge1xuICAgICAgcHJlcGFyZVNwaW5uZXIuc3VjY2VlZCgpO1xuICAgICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3BhY2thZ2VBZnRlckNvcHknLCBidWlsZFBhdGgsIGVsZWN0cm9uVmVyc2lvbiwgcFBsYXRmb3JtLCBwQXJjaCk7XG4gICAgICBkb25lKCk7XG4gICAgfSxcbiAgICBhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICAgIGF3YWl0IHJlYnVpbGRIb29rKFxuICAgICAgICBidWlsZFBhdGgsXG4gICAgICAgIGVsZWN0cm9uVmVyc2lvbixcbiAgICAgICAgcFBsYXRmb3JtLFxuICAgICAgICBwQXJjaCxcbiAgICAgICAgZm9yZ2VDb25maWcuZWxlY3Ryb25SZWJ1aWxkQ29uZmlnLFxuICAgICAgKTtcbiAgICAgIHBhY2thZ2VyU3Bpbm5lciA9IG9yYSgnUGFja2FnaW5nIEFwcGxpY2F0aW9uJykuc3RhcnQoKTtcbiAgICAgIGRvbmUoKTtcbiAgICB9LFxuICBdO1xuXG4gIGFmdGVyQ29weUhvb2tzLnB1c2goYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgY29uc3QgY29waWVkUGFja2FnZUpTT04gPSBhd2FpdCByZWFkTXV0YXRlZFBhY2thZ2VKc29uKGJ1aWxkUGF0aCwgZm9yZ2VDb25maWcpO1xuICAgIGlmIChjb3BpZWRQYWNrYWdlSlNPTi5jb25maWcgJiYgY29waWVkUGFja2FnZUpTT04uY29uZmlnLmZvcmdlKSB7XG4gICAgICBkZWxldGUgY29waWVkUGFja2FnZUpTT04uY29uZmlnLmZvcmdlO1xuICAgIH1cbiAgICBhd2FpdCBmcy53cml0ZUpzb24ocGF0aC5yZXNvbHZlKGJ1aWxkUGF0aCwgJ3BhY2thZ2UuanNvbicpLCBjb3BpZWRQYWNrYWdlSlNPTiwgeyBzcGFjZXM6IDIgfSk7XG4gICAgZG9uZSgpO1xuICB9KTtcblxuICBhZnRlckNvcHlIb29rcy5wdXNoKC4uLnJlc29sdmVIb29rcyhmb3JnZUNvbmZpZy5wYWNrYWdlckNvbmZpZy5hZnRlckNvcHksIGRpcikpO1xuXG4gIGNvbnN0IGFmdGVyUHJ1bmVIb29rcyA9IFtdO1xuXG4gIGlmIChwcnVuZUVuYWJsZWQpIHtcbiAgICBhZnRlclBydW5lSG9va3MucHVzaCguLi5yZXNvbHZlSG9va3MoZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcuYWZ0ZXJQcnVuZSwgZGlyKSk7XG4gIH1cblxuICBhZnRlclBydW5lSG9va3MucHVzaCgoYXN5bmMgKGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoLCBkb25lKSA9PiB7XG4gICAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3BhY2thZ2VBZnRlclBydW5lJywgYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gpO1xuICAgIGRvbmUoKTtcbiAgfSkgYXMgRWxlY3Ryb25QYWNrYWdlckFmdGVyQ29weUhvb2spO1xuXG4gIGNvbnN0IGFmdGVyRXh0cmFjdEhvb2tzID0gWyhhc3luYyAoYnVpbGRQYXRoLCBlbGVjdHJvblZlcnNpb24sIHBQbGF0Zm9ybSwgcEFyY2gsIGRvbmUpID0+IHtcbiAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncGFja2FnZUFmdGVyRXh0cmFjdCcsIGJ1aWxkUGF0aCwgZWxlY3Ryb25WZXJzaW9uLCBwUGxhdGZvcm0sIHBBcmNoKTtcbiAgICBkb25lKCk7XG4gIH0pIGFzIEVsZWN0cm9uUGFja2FnZXJBZnRlckNvcHlIb29rXTtcbiAgYWZ0ZXJFeHRyYWN0SG9va3MucHVzaCguLi5yZXNvbHZlSG9va3MoZm9yZ2VDb25maWcucGFja2FnZXJDb25maWcuYWZ0ZXJFeHRyYWN0LCBkaXIpKTtcblxuICB0eXBlIFBhY2thZ2VyQXJjaCA9IEV4Y2x1ZGU8Rm9yZ2VBcmNoLCAnYXJtJz47XG5cbiAgY29uc3QgcGFja2FnZU9wdHM6IHBhY2thZ2VyLk9wdGlvbnMgPSB7XG4gICAgYXNhcjogZmFsc2UsXG4gICAgb3ZlcndyaXRlOiB0cnVlLFxuICAgIC4uLmZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnLFxuICAgIGRpcixcbiAgICBhcmNoOiBhcmNoIGFzIFBhY2thZ2VyQXJjaCxcbiAgICBwbGF0Zm9ybSxcbiAgICBhZnRlckNvcHk6IHNlcXVlbnRpYWxIb29rcyhhZnRlckNvcHlIb29rcyksXG4gICAgYWZ0ZXJFeHRyYWN0OiBzZXF1ZW50aWFsSG9va3MoYWZ0ZXJFeHRyYWN0SG9va3MpLFxuICAgIGFmdGVyUHJ1bmU6IHNlcXVlbnRpYWxIb29rcyhhZnRlclBydW5lSG9va3MpLFxuICAgIG91dDogY2FsY3VsYXRlZE91dERpcixcbiAgICBlbGVjdHJvblZlcnNpb246IGF3YWl0IGdldEVsZWN0cm9uVmVyc2lvbihkaXIsIHBhY2thZ2VKU09OKSxcbiAgfTtcbiAgcGFja2FnZU9wdHMucXVpZXQgPSB0cnVlO1xuXG4gIGlmIChwYWNrYWdlT3B0cy5hbGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbmZpZy5mb3JnZS5wYWNrYWdlckNvbmZpZy5hbGwgaXMgbm90IHN1cHBvcnRlZCBieSBFbGVjdHJvbiBGb3JnZScpO1xuICB9XG5cbiAgaWYgKCFwYWNrYWdlSlNPTi52ZXJzaW9uICYmICFwYWNrYWdlT3B0cy5hcHBWZXJzaW9uKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgICB3YXJuKGludGVyYWN0aXZlLCAnUGxlYXNlIHNldCBcInZlcnNpb25cIiBvciBcImNvbmZpZy5mb3JnZS5wYWNrYWdlckNvbmZpZy5hcHBWZXJzaW9uXCIgaW4geW91ciBhcHBsaWNhdGlvblxcJ3MgcGFja2FnZS5qc29uIHNvIGF1dG8tdXBkYXRlcyB3b3JrIHByb3Blcmx5Jy55ZWxsb3cpO1xuICB9XG5cbiAgaWYgKHBhY2thZ2VPcHRzLnByZWJ1aWx0QXNhcikge1xuICAgIHRocm93IG5ldyBFcnJvcignY29uZmlnLmZvcmdlLnBhY2thZ2VyQ29uZmlnLnByZWJ1aWx0QXNhciBpcyBub3Qgc3VwcG9ydGVkIGJ5IEVsZWN0cm9uIEZvcmdlJyk7XG4gIH1cblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAnZ2VuZXJhdGVBc3NldHMnKTtcbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ3ByZVBhY2thZ2UnKTtcblxuICBkKCdwYWNrYWdpbmcgd2l0aCBvcHRpb25zJywgcGFja2FnZU9wdHMpO1xuXG4gIGF3YWl0IHBhY2thZ2VyKHBhY2thZ2VPcHRzKTtcblxuICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncG9zdFBhY2thZ2UnKTtcblxuICBpZiAocGFja2FnZXJTcGlubmVyKSBwYWNrYWdlclNwaW5uZXIhLnN1Y2NlZWQoKTtcbn07XG4iXX0=