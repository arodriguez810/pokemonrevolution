"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = upgradeForgeConfig;
exports.updateUpgradedForgeDevDeps = updateUpgradedForgeDevDeps;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _initNpm = require("../api/init-scripts/init-npm");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function mapMakeTargets(forge5Config) {
  const makeTargets = new Map();

  if (forge5Config.makeTargets) {
    for (const [platform, targets] of Object.entries(forge5Config.makeTargets)) {
      for (const target of targets) {
        let platforms = makeTargets.get(target);

        if (platforms === undefined) {
          platforms = [];
          makeTargets.set(target, platforms);
        }

        platforms.push(platform);
      }
    }
  }

  return makeTargets;
}

const forge5MakerMappings = new Map([['electronInstallerDebian', 'deb'], ['electronInstallerDMG', 'dmg'], ['electronInstallerFlatpak', 'flatpak'], ['electronInstallerRedhat', 'rpm'], ['electronInstallerSnap', 'snap'], ['electronWinstallerConfig', 'squirrel'], ['electronWixMSIConfig', 'wix'], ['windowsStoreConfig', 'appx']]);
/**
 * Converts Forge v5 maker config to v6.
 */

function generateForgeMakerConfig(forge5Config) {
  const makeTargets = mapMakeTargets(forge5Config);
  const makers = [];

  for (const [forge5Key, makerType] of forge5MakerMappings) {
    const config = forge5Config[forge5Key];

    if (config) {
      makers.push({
        name: `@electron-forge/maker-${makerType}`,
        config: forge5Config[forge5Key],
        platforms: makeTargets.get(makerType) || null
      });
    }
  }

  const zipPlatforms = makeTargets.get('zip');

  if (zipPlatforms) {
    makers.push({
      name: '@electron-forge/maker-zip',
      platforms: zipPlatforms
    });
  }

  return makers;
}

const forge5PublisherMappings = new Map([['github_repository', 'github'], ['s3', 's3'], ['electron-release-server', 'electron-release-server'], ['snapStore', 'snapcraft']]);
/**
 * Transforms v5 GitHub publisher config to v6 syntax.
 */

function transformGitHubPublisherConfig(config) {
  const {
    name,
    owner,
    options,
    ...gitHubConfig
  } = config;
  gitHubConfig.repository = {
    name,
    owner
  };

  if (options) {
    gitHubConfig.octokitOptions = options;
  }

  return gitHubConfig;
}
/**
 * Converts Forge v5 publisher config to v6.
 */


function generateForgePublisherConfig(forge5Config) {
  const publishers = [];

  for (const [forge5Key, publisherType] of forge5PublisherMappings) {
    let config = forge5Config[forge5Key];

    if (config) {
      if (publisherType === 'github') {
        config = transformGitHubPublisherConfig(config);
      }

      publishers.push({
        config,
        name: `@electron-forge/publisher-${publisherType}`,
        platforms: null
      });
    }
  }

  return publishers;
}
/**
 * Upgrades Forge v5 config to v6.
 */


function upgradeForgeConfig(forge5Config) {
  const forgeConfig = {};

  if (forge5Config.electronPackagerConfig) {
    delete forge5Config.electronPackagerConfig.packageManager;
    forgeConfig.packagerConfig = forge5Config.electronPackagerConfig;
  }

  if (forge5Config.electronRebuildConfig) {
    forgeConfig.electronRebuildConfig = forge5Config.electronRebuildConfig;
  }

  forgeConfig.makers = generateForgeMakerConfig(forge5Config);
  forgeConfig.publishers = generateForgePublisherConfig(forge5Config);
  return forgeConfig;
}

function updateUpgradedForgeDevDeps(packageJSON, devDeps) {
  const forgeConfig = packageJSON.config.forge;
  devDeps = devDeps.filter(dep => !dep.startsWith('@electron-forge/maker-')); // eslint-disable-next-line max-len

  devDeps = devDeps.concat(forgeConfig.makers.map(maker => (0, _initNpm.siblingDep)(_path.default.basename(maker.name)))); // eslint-disable-next-line max-len

  devDeps = devDeps.concat(forgeConfig.publishers.map(publisher => (0, _initNpm.siblingDep)(_path.default.basename(publisher.name))));

  if (Object.keys(packageJSON.devDependencies).find(dep => dep === 'electron-prebuilt-compile')) {
    devDeps = devDeps.concat((0, _initNpm.siblingDep)('plugin-compile'));
  }

  return devDeps;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL3VwZ3JhZGUtZm9yZ2UtY29uZmlnLnRzIl0sIm5hbWVzIjpbIm1hcE1ha2VUYXJnZXRzIiwiZm9yZ2U1Q29uZmlnIiwibWFrZVRhcmdldHMiLCJNYXAiLCJwbGF0Zm9ybSIsInRhcmdldHMiLCJPYmplY3QiLCJlbnRyaWVzIiwidGFyZ2V0IiwicGxhdGZvcm1zIiwiZ2V0IiwidW5kZWZpbmVkIiwic2V0IiwicHVzaCIsImZvcmdlNU1ha2VyTWFwcGluZ3MiLCJnZW5lcmF0ZUZvcmdlTWFrZXJDb25maWciLCJtYWtlcnMiLCJmb3JnZTVLZXkiLCJtYWtlclR5cGUiLCJjb25maWciLCJuYW1lIiwiemlwUGxhdGZvcm1zIiwiZm9yZ2U1UHVibGlzaGVyTWFwcGluZ3MiLCJ0cmFuc2Zvcm1HaXRIdWJQdWJsaXNoZXJDb25maWciLCJvd25lciIsIm9wdGlvbnMiLCJnaXRIdWJDb25maWciLCJyZXBvc2l0b3J5Iiwib2N0b2tpdE9wdGlvbnMiLCJnZW5lcmF0ZUZvcmdlUHVibGlzaGVyQ29uZmlnIiwicHVibGlzaGVycyIsInB1Ymxpc2hlclR5cGUiLCJ1cGdyYWRlRm9yZ2VDb25maWciLCJmb3JnZUNvbmZpZyIsImVsZWN0cm9uUGFja2FnZXJDb25maWciLCJwYWNrYWdlTWFuYWdlciIsInBhY2thZ2VyQ29uZmlnIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwidXBkYXRlVXBncmFkZWRGb3JnZURldkRlcHMiLCJwYWNrYWdlSlNPTiIsImRldkRlcHMiLCJmb3JnZSIsImZpbHRlciIsImRlcCIsInN0YXJ0c1dpdGgiLCJjb25jYXQiLCJtYXAiLCJtYWtlciIsInBhdGgiLCJiYXNlbmFtZSIsInB1Ymxpc2hlciIsImtleXMiLCJkZXZEZXBlbmRlbmNpZXMiLCJmaW5kIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBTUE7O0FBQ0E7Ozs7QUFJQSxTQUFTQSxjQUFULENBQXdCQyxZQUF4QixFQUF5RTtBQUN2RSxRQUFNQyxXQUFXLEdBQUcs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Q29udGVudCI6WyJpbXBvcnQge1xuICBGb3JnZUNvbmZpZyxcbiAgRm9yZ2VQbGF0Zm9ybSxcbiAgSUZvcmdlUmVzb2x2YWJsZU1ha2VyLFxuICBJRm9yZ2VSZXNvbHZhYmxlUHVibGlzaGVyLFxufSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgc2libGluZ0RlcCB9IGZyb20gJy4uL2FwaS9pbml0LXNjcmlwdHMvaW5pdC1ucG0nO1xuXG50eXBlIE1ha2VUYXJnZXRzID0geyBzdHJpbmc6IHN0cmluZ1tdIH07XG5cbmZ1bmN0aW9uIG1hcE1ha2VUYXJnZXRzKGZvcmdlNUNvbmZpZzogYW55KTogTWFwPHN0cmluZywgRm9yZ2VQbGF0Zm9ybVtdPiB7XG4gIGNvbnN0IG1ha2VUYXJnZXRzID0gbmV3IE1hcDxzdHJpbmcsIEZvcmdlUGxhdGZvcm1bXT4oKTtcbiAgaWYgKGZvcmdlNUNvbmZpZy5tYWtlVGFyZ2V0cykge1xuICAgIGZvciAoY29uc3QgW3BsYXRmb3JtLCB0YXJnZXRzXSBvZiBPYmplY3QuZW50cmllcyhmb3JnZTVDb25maWcubWFrZVRhcmdldHMgYXMgTWFrZVRhcmdldHMpKSB7XG4gICAgICBmb3IgKGNvbnN0IHRhcmdldCBvZiB0YXJnZXRzKSB7XG4gICAgICAgIGxldCBwbGF0Zm9ybXMgPSBtYWtlVGFyZ2V0cy5nZXQodGFyZ2V0KTtcbiAgICAgICAgaWYgKHBsYXRmb3JtcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcGxhdGZvcm1zID0gW107XG4gICAgICAgICAgbWFrZVRhcmdldHMuc2V0KHRhcmdldCwgcGxhdGZvcm1zKTtcbiAgICAgICAgfVxuICAgICAgICBwbGF0Zm9ybXMucHVzaChwbGF0Zm9ybSBhcyBGb3JnZVBsYXRmb3JtKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWFrZVRhcmdldHM7XG59XG5cbmNvbnN0IGZvcmdlNU1ha2VyTWFwcGluZ3MgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPihbXG4gIFsnZWxlY3Ryb25JbnN0YWxsZXJEZWJpYW4nLCAnZGViJ10sXG4gIFsnZWxlY3Ryb25JbnN0YWxsZXJETUcnLCAnZG1nJ10sXG4gIFsnZWxlY3Ryb25JbnN0YWxsZXJGbGF0cGFrJywgJ2ZsYXRwYWsnXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlclJlZGhhdCcsICdycG0nXSxcbiAgWydlbGVjdHJvbkluc3RhbGxlclNuYXAnLCAnc25hcCddLFxuICBbJ2VsZWN0cm9uV2luc3RhbGxlckNvbmZpZycsICdzcXVpcnJlbCddLFxuICBbJ2VsZWN0cm9uV2l4TVNJQ29uZmlnJywgJ3dpeCddLFxuICBbJ3dpbmRvd3NTdG9yZUNvbmZpZycsICdhcHB4J10sXG5dKTtcblxuLyoqXG4gKiBDb252ZXJ0cyBGb3JnZSB2NSBtYWtlciBjb25maWcgdG8gdjYuXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlRm9yZ2VNYWtlckNvbmZpZyhmb3JnZTVDb25maWc6IGFueSk6IElGb3JnZVJlc29sdmFibGVNYWtlcltdIHtcbiAgY29uc3QgbWFrZVRhcmdldHMgPSBtYXBNYWtlVGFyZ2V0cyhmb3JnZTVDb25maWcpO1xuICBjb25zdCBtYWtlcnM6IElGb3JnZVJlc29sdmFibGVNYWtlcltdID0gW107XG5cbiAgZm9yIChjb25zdCBbZm9yZ2U1S2V5LCBtYWtlclR5cGVdIG9mIGZvcmdlNU1ha2VyTWFwcGluZ3MpIHtcbiAgICBjb25zdCBjb25maWcgPSBmb3JnZTVDb25maWdbZm9yZ2U1S2V5XTtcbiAgICBpZiAoY29uZmlnKSB7XG4gICAgICBtYWtlcnMucHVzaCh7XG4gICAgICAgIG5hbWU6IGBAZWxlY3Ryb24tZm9yZ2UvbWFrZXItJHttYWtlclR5cGV9YCxcbiAgICAgICAgY29uZmlnOiBmb3JnZTVDb25maWdbZm9yZ2U1S2V5XSxcbiAgICAgICAgcGxhdGZvcm1zOiBtYWtlVGFyZ2V0cy5nZXQobWFrZXJUeXBlKSB8fCBudWxsLFxuICAgICAgfSBhcyBJRm9yZ2VSZXNvbHZhYmxlTWFrZXIpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHppcFBsYXRmb3JtcyA9IG1ha2VUYXJnZXRzLmdldCgnemlwJyk7XG4gIGlmICh6aXBQbGF0Zm9ybXMpIHtcbiAgICBtYWtlcnMucHVzaCh7XG4gICAgICBuYW1lOiAnQGVsZWN0cm9uLWZvcmdlL21ha2VyLXppcCcsXG4gICAgICBwbGF0Zm9ybXM6IHppcFBsYXRmb3JtcyxcbiAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gIH1cblxuICByZXR1cm4gbWFrZXJzO1xufVxuXG5jb25zdCBmb3JnZTVQdWJsaXNoZXJNYXBwaW5ncyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KFtcbiAgWydnaXRodWJfcmVwb3NpdG9yeScsICdnaXRodWInXSxcbiAgWydzMycsICdzMyddLFxuICBbJ2VsZWN0cm9uLXJlbGVhc2Utc2VydmVyJywgJ2VsZWN0cm9uLXJlbGVhc2Utc2VydmVyJ10sXG4gIFsnc25hcFN0b3JlJywgJ3NuYXBjcmFmdCddLFxuXSk7XG5cbi8qKlxuICogVHJhbnNmb3JtcyB2NSBHaXRIdWIgcHVibGlzaGVyIGNvbmZpZyB0byB2NiBzeW50YXguXG4gKi9cbmZ1bmN0aW9uIHRyYW5zZm9ybUdpdEh1YlB1Ymxpc2hlckNvbmZpZyhjb25maWc6IGFueSkge1xuICBjb25zdCB7XG4gICAgbmFtZSwgb3duZXIsIG9wdGlvbnMsIC4uLmdpdEh1YkNvbmZpZ1xuICB9ID0gY29uZmlnO1xuICBnaXRIdWJDb25maWcucmVwb3NpdG9yeSA9IHsgbmFtZSwgb3duZXIgfTtcbiAgaWYgKG9wdGlvbnMpIHtcbiAgICBnaXRIdWJDb25maWcub2N0b2tpdE9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgcmV0dXJuIGdpdEh1YkNvbmZpZztcbn1cblxuLyoqXG4gKiBDb252ZXJ0cyBGb3JnZSB2NSBwdWJsaXNoZXIgY29uZmlnIHRvIHY2LlxuICovXG5mdW5jdGlvbiBnZW5lcmF0ZUZvcmdlUHVibGlzaGVyQ29uZmlnKGZvcmdlNUNvbmZpZzogYW55KTogSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcltdIHtcbiAgY29uc3QgcHVibGlzaGVyczogSUZvcmdlUmVzb2x2YWJsZVB1Ymxpc2hlcltdID0gW107XG5cbiAgZm9yIChjb25zdCBbZm9yZ2U1S2V5LCBwdWJsaXNoZXJUeXBlXSBvZiBmb3JnZTVQdWJsaXNoZXJNYXBwaW5ncykge1xuICAgIGxldCBjb25maWcgPSBmb3JnZTVDb25maWdbZm9yZ2U1S2V5XTtcbiAgICBpZiAoY29uZmlnKSB7XG4gICAgICBpZiAocHVibGlzaGVyVHlwZSA9PT0gJ2dpdGh1YicpIHtcbiAgICAgICAgY29uZmlnID0gdHJhbnNmb3JtR2l0SHViUHVibGlzaGVyQ29uZmlnKGNvbmZpZyk7XG4gICAgICB9XG4gICAgICBwdWJsaXNoZXJzLnB1c2goe1xuICAgICAgICBjb25maWcsXG4gICAgICAgIG5hbWU6IGBAZWxlY3Ryb24tZm9yZ2UvcHVibGlzaGVyLSR7cHVibGlzaGVyVHlwZX1gLFxuICAgICAgICBwbGF0Zm9ybXM6IG51bGwsXG4gICAgICB9IGFzIElGb3JnZVJlc29sdmFibGVNYWtlcik7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHB1Ymxpc2hlcnM7XG59XG5cbi8qKlxuICogVXBncmFkZXMgRm9yZ2UgdjUgY29uZmlnIHRvIHY2LlxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB1cGdyYWRlRm9yZ2VDb25maWcoZm9yZ2U1Q29uZmlnOiBhbnkpOiBGb3JnZUNvbmZpZyB7XG4gIGNvbnN0IGZvcmdlQ29uZmlnOiBGb3JnZUNvbmZpZyA9ICh7fSBhcyBGb3JnZUNvbmZpZyk7XG5cbiAgaWYgKGZvcmdlNUNvbmZpZy5lbGVjdHJvblBhY2thZ2VyQ29uZmlnKSB7XG4gICAgZGVsZXRlIGZvcmdlNUNvbmZpZy5lbGVjdHJvblBhY2thZ2VyQ29uZmlnLnBhY2thZ2VNYW5hZ2VyO1xuICAgIGZvcmdlQ29uZmlnLnBhY2thZ2VyQ29uZmlnID0gZm9yZ2U1Q29uZmlnLmVsZWN0cm9uUGFja2FnZXJDb25maWc7XG4gIH1cbiAgaWYgKGZvcmdlNUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcpIHtcbiAgICBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcgPSBmb3JnZTVDb25maWcuZWxlY3Ryb25SZWJ1aWxkQ29uZmlnO1xuICB9XG4gIGZvcmdlQ29uZmlnLm1ha2VycyA9IGdlbmVyYXRlRm9yZ2VNYWtlckNvbmZpZyhmb3JnZTVDb25maWcpO1xuICBmb3JnZUNvbmZpZy5wdWJsaXNoZXJzID0gZ2VuZXJhdGVGb3JnZVB1Ymxpc2hlckNvbmZpZyhmb3JnZTVDb25maWcpO1xuXG4gIHJldHVybiBmb3JnZUNvbmZpZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVVwZ3JhZGVkRm9yZ2VEZXZEZXBzKHBhY2thZ2VKU09OOiBhbnksIGRldkRlcHM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICBjb25zdCBmb3JnZUNvbmZpZyA9IHBhY2thZ2VKU09OLmNvbmZpZy5mb3JnZTtcbiAgZGV2RGVwcyA9IGRldkRlcHMuZmlsdGVyKChkZXApID0+ICFkZXAuc3RhcnRzV2l0aCgnQGVsZWN0cm9uLWZvcmdlL21ha2VyLScpKTtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgZGV2RGVwcyA9IGRldkRlcHMuY29uY2F0KGZvcmdlQ29uZmlnLm1ha2Vycy5tYXAoKG1ha2VyOiBJRm9yZ2VSZXNvbHZhYmxlTWFrZXIpID0+IHNpYmxpbmdEZXAocGF0aC5iYXNlbmFtZShtYWtlci5uYW1lKSkpKTtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG1heC1sZW5cbiAgZGV2RGVwcyA9IGRldkRlcHMuY29uY2F0KGZvcmdlQ29uZmlnLnB1Ymxpc2hlcnMubWFwKChwdWJsaXNoZXI6IElGb3JnZVJlc29sdmFibGVQdWJsaXNoZXIpID0+IHNpYmxpbmdEZXAocGF0aC5iYXNlbmFtZShwdWJsaXNoZXIubmFtZSkpKSk7XG5cbiAgaWYgKE9iamVjdC5rZXlzKHBhY2thZ2VKU09OLmRldkRlcGVuZGVuY2llcykuZmluZCgoZGVwOiBzdHJpbmcpID0+IGRlcCA9PT0gJ2VsZWN0cm9uLXByZWJ1aWx0LWNvbXBpbGUnKSkge1xuICAgIGRldkRlcHMgPSBkZXZEZXBzLmNvbmNhdChzaWJsaW5nRGVwKCdwbHVnaW4tY29tcGlsZScpKTtcbiAgfVxuXG4gIHJldHVybiBkZXZEZXBzO1xufVxuIl19