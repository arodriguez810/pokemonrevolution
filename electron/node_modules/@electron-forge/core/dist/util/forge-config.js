"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setInitialForgeConfig = setInitialForgeConfig;
exports.fromBuildIdentifier = fromBuildIdentifier;
exports.forgeConfigIsValidFilePath = forgeConfigIsValidFilePath;
exports.renderConfigTemplate = renderConfigTemplate;
exports.default = void 0;

require("source-map-support/register");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _path = _interopRequireDefault(require("path"));

var _lodash = require("lodash");

var _readPackageJson = require("./read-package-json");

var _pluginInterface = _interopRequireDefault(require("./plugin-interface"));

var _hook = require("./hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const underscoreCase = str => str.replace(/(.)([A-Z][a-z]+)/g, '$1_$2').replace(/([a-z0-9])([A-Z])/g, '$1_$2').toUpperCase(); // eslint-disable-next-line arrow-parens


const proxify = (buildIdentifier, object, envPrefix) => {
  let newObject = {};

  if (Array.isArray(object)) {
    newObject = [];
  }

  for (const [key, val] of Object.entries(object)) {
    if (typeof val === 'object' && key !== 'pluginInterface' && !(val instanceof RegExp)) {
      newObject[key] = proxify(buildIdentifier, object[key], `${envPrefix}_${underscoreCase(key)}`);
    } else {
      newObject[key] = object[key];
    }
  }

  return new Proxy(newObject, {
    get(target, name, receiver) {
      // eslint-disable-next-line no-prototype-builtins
      if (!target.hasOwnProperty(name) && typeof name === 'string') {
        const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`];
        if (envValue) return envValue;
      }

      const value = Reflect.get(target, name, receiver); // eslint-disable-next-line no-underscore-dangle

      if (value && typeof value === 'object' && value.__isMagicBuildIdentifierMap) {
        const identifier = typeof buildIdentifier === 'function' ? buildIdentifier() : buildIdentifier;
        return value.map[identifier];
      }

      return value;
    },

    getOwnPropertyDescriptor(target, name) {
      const envValue = process.env[`${envPrefix}_${underscoreCase(name)}`]; // eslint-disable-next-line no-prototype-builtins

      if (target.hasOwnProperty(name)) {
        return Reflect.getOwnPropertyDescriptor(target, name);
      }

      if (envValue) {
        return {
          writable: true,
          enumerable: true,
          configurable: true,
          value: envValue
        };
      }

      return undefined;
    }

  });
};
/**
 * Sets sensible defaults for the `config.forge` object.
 */


function setInitialForgeConfig(packageJSON) {
  const {
    name = ''
  } = packageJSON;
  packageJSON.config.forge.makers[0].config.name = name.replace(/-/g, '_');
}

function fromBuildIdentifier(map) {
  return {
    map,
    __isMagicBuildIdentifierMap: true
  };
}

async function forgeConfigIsValidFilePath(dir, forgeConfig) {
  return typeof forgeConfig === 'string' && ((await _fsExtra.default.pathExists(_path.default.resolve(dir, forgeConfig))) || _fsExtra.default.pathExists(_path.default.resolve(dir, `${forgeConfig}.js`)));
}

function renderConfigTemplate(dir, templateObj, obj) {
  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === 'object' && value !== null) {
      renderConfigTemplate(dir, templateObj, value);
    } else if (typeof value === 'string') {
      obj[key] = (0, _lodash.template)(value)(templateObj);

      if (obj[key].startsWith('require:')) {
        // eslint-disable-next-line global-require, import/no-dynamic-require
        obj[key] = require(_path.default.resolve(dir, obj[key].substr(8)));
      }
    }
  }
}

var _default = async dir => {
  const packageJSON = await (0, _readPackageJson.readRawPackageJson)(dir);
  let forgeConfig = packageJSON.config && packageJSON.config.forge ? packageJSON.config.forge : null;

  if (!forgeConfig) {
    if (await _fsExtra.default.pathExists(_path.default.resolve(dir, 'forge.config.js'))) {
      forgeConfig = 'forge.config.js';
    } else {
      forgeConfig = {};
    }
  }

  if (await forgeConfigIsValidFilePath(dir, forgeConfig)) {
    try {
      // eslint-disable-next-line global-require, import/no-dynamic-require
      forgeConfig = require(_path.default.resolve(dir, forgeConfig));
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error(`Failed to load: ${_path.default.resolve(dir, forgeConfig)}`);
      throw err;
    }
  } else if (typeof forgeConfig !== 'object') {
    throw new Error('Expected packageJSON.config.forge to be an object or point to a requirable JS file');
  }

  forgeConfig = {
    electronRebuildConfig: {},
    packagerConfig: {},
    makers: [],
    publishers: [],
    plugins: [],
    ...forgeConfig
  };
  const templateObj = { ...packageJSON,
    year: new Date().getFullYear()
  };
  renderConfigTemplate(dir, templateObj, forgeConfig);
  forgeConfig.pluginInterface = new _pluginInterface.default(dir, forgeConfig);
  forgeConfig = await (0, _hook.runMutatingHook)(forgeConfig, 'resolveForgeConfig', forgeConfig);
  return proxify(forgeConfig.buildIdentifier || '', forgeConfig, 'ELECTRON_FORGE');
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL2ZvcmdlLWNvbmZpZy50cyJdLCJuYW1lcyI6WyJ1bmRlcnNjb3JlQ2FzZSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsInByb3hpZnkiLCJidWlsZElkZW50aWZpZXIiLCJvYmplY3QiLCJlbnZQcmVmaXgiLCJuZXdPYmplY3QiLCJBcnJheSIsImlzQXJyYXkiLCJrZXkiLCJ2YWwiLCJPYmplY3QiLCJlbnRyaWVzIiwiUmVnRXhwIiwiUHJveHkiLCJnZXQiLCJ0YXJnZXQiLCJuYW1lIiwicmVjZWl2ZXIiLCJoYXNPd25Qcm9wZXJ0eSIsImVudlZhbHVlIiwicHJvY2VzcyIsImVudiIsInZhbHVlIiwiUmVmbGVjdCIsIl9faXNNYWdpY0J1aWxkSWRlbnRpZmllck1hcCIsImlkZW50aWZpZXIiLCJtYXAiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ3cml0YWJsZSIsImVudW1lcmFibGUiLCJjb25maWd1cmFibGUiLCJ1bmRlZmluZWQiLCJzZXRJbml0aWFsRm9yZ2VDb25maWciLCJwYWNrYWdlSlNPTiIsImNvbmZpZyIsImZvcmdlIiwibWFrZXJzIiwiZnJvbUJ1aWxkSWRlbnRpZmllciIsImZvcmdlQ29uZmlnSXNWYWxpZEZpbGVQYXRoIiwiZGlyIiwiZm9yZ2VDb25maWciLCJmcyIsInBhdGhFeGlzdHMiLCJwYXRoIiwicmVzb2x2ZSIsInJlbmRlckNvbmZpZ1RlbXBsYXRlIiwidGVtcGxhdGVPYmoiLCJvYmoiLCJzdGFydHNXaXRoIiwicmVxdWlyZSIsInN1YnN0ciIsImVyciIsImNvbnNvbGUiLCJlcnJvciIsIkVycm9yIiwiZWxlY3Ryb25SZWJ1aWxkQ29uZmlnIiwicGFja2FnZXJDb25maWciLCJwdWJsaXNoZXJzIiwicGx1Z2lucyIsInllYXIiLCJEYXRlIiwiZ2V0RnVsbFllYXIiLCJwbHVnaW5JbnRlcmZhY2UiLCJQbHVnaW5JbnRlcmZhY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFDQTs7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bnQiOlsiaW1wb3J0IHsgRm9yZ2VDb25maWcgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHRlbXBsYXRlIH0gZnJvbSAnbG9kYXNoJztcblxuaW1wb3J0IHsgcmVhZFJhd1BhY2thZ2VKc29uIH0gZnJvbSAnLi9yZWFkLXBhY2thZ2UtanNvbic7XG5pbXBvcnQgUGx1Z2luSW50ZXJmYWNlIGZyb20gJy4vcGx1Z2luLWludGVyZmFjZSc7XG5pbXBvcnQgeyBydW5NdXRhdGluZ0hvb2sgfSBmcm9tICcuL2hvb2snO1xuXG5jb25zdCB1bmRlcnNjb3JlQ2FzZSA9IChzdHI6IHN0cmluZykgPT4gc3RyLnJlcGxhY2UoLyguKShbQS1aXVthLXpdKykvZywgJyQxXyQyJykucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxXyQyJykudG9VcHBlckNhc2UoKTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGFycm93LXBhcmVuc1xuY29uc3QgcHJveGlmeSA9IDxUIGV4dGVuZHMgb2JqZWN0PihcbiAgYnVpbGRJZGVudGlmaWVyOiBzdHJpbmcgfCAoKCkgPT4gc3RyaW5nKSxcbiAgb2JqZWN0OiBULFxuICBlbnZQcmVmaXg6IHN0cmluZyxcbik6IFQgPT4ge1xuICBsZXQgbmV3T2JqZWN0OiBUID0ge30gYXMgYW55O1xuICBpZiAoQXJyYXkuaXNBcnJheShvYmplY3QpKSB7XG4gICAgbmV3T2JqZWN0ID0gW10gYXMgYW55O1xuICB9XG5cbiAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKG9iamVjdCkpIHtcbiAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ29iamVjdCcgJiYga2V5ICE9PSAncGx1Z2luSW50ZXJmYWNlJyAmJiAhKHZhbCBpbnN0YW5jZW9mIFJlZ0V4cCkpIHtcbiAgICAgIChuZXdPYmplY3QgYXMgYW55KVtrZXldID0gcHJveGlmeShidWlsZElkZW50aWZpZXIsIChvYmplY3QgYXMgYW55KVtrZXldLCBgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2Uoa2V5KX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgKG5ld09iamVjdCBhcyBhbnkpW2tleV0gPSAob2JqZWN0IGFzIGFueSlba2V5XTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbmV3IFByb3h5PFQ+KG5ld09iamVjdCwge1xuICAgIGdldCh0YXJnZXQsIG5hbWUsIHJlY2VpdmVyKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcHJvdG90eXBlLWJ1aWx0aW5zXG4gICAgICBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB0eXBlb2YgbmFtZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgY29uc3QgZW52VmFsdWUgPSBwcm9jZXNzLmVudltgJHtlbnZQcmVmaXh9XyR7dW5kZXJzY29yZUNhc2UobmFtZSl9YF07XG4gICAgICAgIGlmIChlbnZWYWx1ZSkgcmV0dXJuIGVudlZhbHVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdmFsdWUgPSBSZWZsZWN0LmdldCh0YXJnZXQsIG5hbWUsIHJlY2VpdmVyKTtcblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZS5fX2lzTWFnaWNCdWlsZElkZW50aWZpZXJNYXApIHtcbiAgICAgICAgY29uc3QgaWRlbnRpZmllciA9IHR5cGVvZiBidWlsZElkZW50aWZpZXIgPT09ICdmdW5jdGlvbicgPyBidWlsZElkZW50aWZpZXIoKSA6IGJ1aWxkSWRlbnRpZmllcjtcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcFtpZGVudGlmaWVyXTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9LFxuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIG5hbWUpIHtcbiAgICAgIGNvbnN0IGVudlZhbHVlID0gcHJvY2Vzcy5lbnZbYCR7ZW52UHJlZml4fV8ke3VuZGVyc2NvcmVDYXNlKG5hbWUgYXMgc3RyaW5nKX1gXTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1wcm90b3R5cGUtYnVpbHRpbnNcbiAgICAgIGlmICh0YXJnZXQuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgbmFtZSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChlbnZWYWx1ZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgICAgIHZhbHVlOiBlbnZWYWx1ZSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9LFxuICB9KTtcbn07XG5cbi8qKlxuICogU2V0cyBzZW5zaWJsZSBkZWZhdWx0cyBmb3IgdGhlIGBjb25maWcuZm9yZ2VgIG9iamVjdC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNldEluaXRpYWxGb3JnZUNvbmZpZyhwYWNrYWdlSlNPTjogYW55KSB7XG4gIGNvbnN0IHsgbmFtZSA9ICcnIH0gPSBwYWNrYWdlSlNPTjtcblxuICBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UubWFrZXJzWzBdLmNvbmZpZy5uYW1lID0gbmFtZS5yZXBsYWNlKC8tL2csICdfJyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tQnVpbGRJZGVudGlmaWVyPFQ+KG1hcDogeyBba2V5OiBzdHJpbmddOiBUIHwgdW5kZWZpbmVkIH0pIHtcbiAgcmV0dXJuIHtcbiAgICBtYXAsXG4gICAgX19pc01hZ2ljQnVpbGRJZGVudGlmaWVyTWFwOiB0cnVlLFxuICB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZm9yZ2VDb25maWdJc1ZhbGlkRmlsZVBhdGgoZGlyOiBzdHJpbmcsIGZvcmdlQ29uZmlnOiBzdHJpbmcgfCBGb3JnZUNvbmZpZykge1xuICByZXR1cm4gdHlwZW9mIGZvcmdlQ29uZmlnID09PSAnc3RyaW5nJ1xuICAgICYmIChcbiAgICAgIGF3YWl0IGZzLnBhdGhFeGlzdHMocGF0aC5yZXNvbHZlKGRpciwgZm9yZ2VDb25maWcpKVxuICAgICAgfHwgZnMucGF0aEV4aXN0cyhwYXRoLnJlc29sdmUoZGlyLCBgJHtmb3JnZUNvbmZpZ30uanNgKSlcbiAgICApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyQ29uZmlnVGVtcGxhdGUoZGlyOiBzdHJpbmcsIHRlbXBsYXRlT2JqOiBhbnksIG9iajogYW55KSB7XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG9iaikpIHtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiB2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgcmVuZGVyQ29uZmlnVGVtcGxhdGUoZGlyLCB0ZW1wbGF0ZU9iaiwgdmFsdWUpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgb2JqW2tleV0gPSB0ZW1wbGF0ZSh2YWx1ZSkodGVtcGxhdGVPYmopO1xuICAgICAgaWYgKG9ialtrZXldLnN0YXJ0c1dpdGgoJ3JlcXVpcmU6JykpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGdsb2JhbC1yZXF1aXJlLCBpbXBvcnQvbm8tZHluYW1pYy1yZXF1aXJlXG4gICAgICAgIG9ialtrZXldID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBvYmpba2V5XS5zdWJzdHIoOCkpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgKGRpcjogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IHBhY2thZ2VKU09OID0gYXdhaXQgcmVhZFJhd1BhY2thZ2VKc29uKGRpcik7XG4gIGxldCBmb3JnZUNvbmZpZzogRm9yZ2VDb25maWcgfCBzdHJpbmcgfCBudWxsID0gKHBhY2thZ2VKU09OLmNvbmZpZyAmJiBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UpXG4gICAgPyBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2VcbiAgICA6IG51bGw7XG5cbiAgaWYgKCFmb3JnZUNvbmZpZykge1xuICAgIGlmIChhd2FpdCBmcy5wYXRoRXhpc3RzKHBhdGgucmVzb2x2ZShkaXIsICdmb3JnZS5jb25maWcuanMnKSkpIHtcbiAgICAgIGZvcmdlQ29uZmlnID0gJ2ZvcmdlLmNvbmZpZy5qcyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvcmdlQ29uZmlnID0ge30gYXMgYW55IGFzIEZvcmdlQ29uZmlnO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhd2FpdCBmb3JnZUNvbmZpZ0lzVmFsaWRGaWxlUGF0aChkaXIsIGZvcmdlQ29uZmlnKSkge1xuICAgIHRyeSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZ2xvYmFsLXJlcXVpcmUsIGltcG9ydC9uby1keW5hbWljLXJlcXVpcmVcbiAgICAgIGZvcmdlQ29uZmlnID0gcmVxdWlyZShwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZyBhcyBzdHJpbmcpKSBhcyBGb3JnZUNvbmZpZztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gbG9hZDogJHtwYXRoLnJlc29sdmUoZGlyLCBmb3JnZUNvbmZpZyBhcyBzdHJpbmcpfWApO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfSBlbHNlIGlmICh0eXBlb2YgZm9yZ2VDb25maWcgIT09ICdvYmplY3QnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdFeHBlY3RlZCBwYWNrYWdlSlNPTi5jb25maWcuZm9yZ2UgdG8gYmUgYW4gb2JqZWN0IG9yIHBvaW50IHRvIGEgcmVxdWlyYWJsZSBKUyBmaWxlJyk7XG4gIH1cbiAgZm9yZ2VDb25maWcgPSB7XG4gICAgZWxlY3Ryb25SZWJ1aWxkQ29uZmlnOiB7fSxcbiAgICBwYWNrYWdlckNvbmZpZzoge30sXG4gICAgbWFrZXJzOiBbXSxcbiAgICBwdWJsaXNoZXJzOiBbXSxcbiAgICBwbHVnaW5zOiBbXSxcbiAgICAuLi5mb3JnZUNvbmZpZyxcbiAgfTtcblxuICBjb25zdCB0ZW1wbGF0ZU9iaiA9IHsgLi4ucGFja2FnZUpTT04sIHllYXI6IChuZXcgRGF0ZSgpKS5nZXRGdWxsWWVhcigpIH07XG4gIHJlbmRlckNvbmZpZ1RlbXBsYXRlKGRpciwgdGVtcGxhdGVPYmosIGZvcmdlQ29uZmlnKTtcblxuICBmb3JnZUNvbmZpZy5wbHVnaW5JbnRlcmZhY2UgPSBuZXcgUGx1Z2luSW50ZXJmYWNlKGRpciwgZm9yZ2VDb25maWcpO1xuXG4gIGZvcmdlQ29uZmlnID0gYXdhaXQgcnVuTXV0YXRpbmdIb29rKGZvcmdlQ29uZmlnLCAncmVzb2x2ZUZvcmdlQ29uZmlnJywgZm9yZ2VDb25maWcpO1xuXG4gIHJldHVybiBwcm94aWZ5PEZvcmdlQ29uZmlnPihmb3JnZUNvbmZpZy5idWlsZElkZW50aWZpZXIgfHwgJycsIGZvcmdlQ29uZmlnLCAnRUxFQ1RST05fRk9SR0UnKTtcbn07XG4iXX0=