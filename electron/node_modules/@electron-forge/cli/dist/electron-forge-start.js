"use strict";

require("source-map-support/register");

var _core = require("@electron-forge/core");

var _fsExtra = _interopRequireDefault(require("fs-extra"));

var _commander = _interopRequireDefault(require("commander"));

var _path = _interopRequireDefault(require("path"));

require("./util/terminate");

var _workingDir = _interopRequireDefault(require("./util/working-dir"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(async () => {
  let commandArgs = process.argv;
  let appArgs;
  const doubleDashIndex = process.argv.indexOf('--');

  if (doubleDashIndex !== -1) {
    commandArgs = process.argv.slice(0, doubleDashIndex);
    appArgs = process.argv.slice(doubleDashIndex + 1);
  }

  let dir = process.cwd();

  _commander.default.version((await _fsExtra.default.readJson(_path.default.resolve(__dirname, '../package.json'))).version).arguments('[cwd]').option('-p, --app-path <path>', 'Override the path to the Electron app to launch (defaults to \'.\')').option('-l, --enable-logging', 'Enable advanced logging.  This will log internal Electron things').option('-n, --run-as-node', 'Run the Electron app as a Node.JS script').option('--vscode', 'Used to enable arg transformation for debugging Electron through VSCode.  Do not use yourself.').option('-i, --inspect-electron', 'Triggers inspect mode on Electron to allow debugging the main process.  Electron >1.7 only').action(cwd => {
    dir = (0, _workingDir.default)(dir, cwd);
  }).parse(commandArgs);

  _commander.default.on('--help', () => {
    console.log('  Any arguments found after "--" will be passed to the Electron app, e.g.');
    console.log('');
    console.log('    $ electron-forge /path/to/project -l -- -d -f foo.txt');
    console.log('');
    console.log('  will pass the arguments "-d -f foo.txt" to the Electron app');
  });

  const opts = {
    dir,
    interactive: true,
    enableLogging: !!_commander.default.enableLogging,
    runAsNode: !!_commander.default.runAsNode,
    inspect: !!_commander.default.inspectElectron
  };

  if (_commander.default.vscode && appArgs) {
    // Args are in the format ~arg~ so we need to strip the "~"
    appArgs = appArgs.map(arg => arg.substr(1, arg.length - 2)).filter(arg => arg.length > 0);
  }

  if (_commander.default.appPath) opts.appPath = _commander.default.appPath;
  if (appArgs) opts.args = appArgs;
  const spawned = await _core.api.start(opts);
  await new Promise(resolve => {
    const listenForExit = child => {
      let onExit;
      let onRestart;

      const removeListeners = () => {
        child.removeListener('exit', onExit);
        child.removeListener('restarted', onRestart);
      };

      onExit = code => {
        removeListeners();
        if (spawned.restarted) return;

        if (code !== 0) {
          process.exit(code);
        }

        resolve();
      };

      onRestart = newChild => {
        removeListeners();
        listenForExit(newChild);
      };

      child.on('exit', onExit);
      child.on('restarted', onRestart);
    };

    listenForExit(spawned);
  });
})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9lbGVjdHJvbi1mb3JnZS1zdGFydC50cyJdLCJuYW1lcyI6WyJjb21tYW5kQXJncyIsInByb2Nlc3MiLCJhcmd2IiwiYXBwQXJncyIsImRvdWJsZURhc2hJbmRleCIsImluZGV4T2YiLCJzbGljZSIsImRpciIsImN3ZCIsInByb2dyYW0iLCJ2ZXJzaW9uIiwiZnMiLCJyZWFkSnNvbiIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiYXJndW1lbnRzIiwib3B0aW9uIiwiYWN0aW9uIiwicGFyc2UiLCJvbiIsImNvbnNvbGUiLCJsb2ciLCJvcHRzIiwiaW50ZXJhY3RpdmUiLCJlbmFibGVMb2dnaW5nIiwicnVuQXNOb2RlIiwiaW5zcGVjdCIsImluc3BlY3RFbGVjdHJvbiIsInZzY29kZSIsIm1hcCIsImFyZyIsInN1YnN0ciIsImxlbmd0aCIsImZpbHRlciIsImFwcFBhdGgiLCJhcmdzIiwic3Bhd25lZCIsImFwaSIsInN0YXJ0IiwiUHJvbWlzZSIsImxpc3RlbkZvckV4aXQiLCJjaGlsZCIsIm9uRXhpdCIsIm9uUmVzdGFydCIsInJlbW92ZUxpc3RlbmVycyIsInJlbW92ZUxpc3RlbmVyIiwiY29kZSIsInJlc3RhcnRlZCIsImV4aXQiLCJuZXdDaGlsZCJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBOztBQUdBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOzs7O0FBRUEsQ0FBQyxZQUFZO0FBQ1gsTUFBSUEsV0FBVyxHQUFHQyxPQUFPLENBQUNDLElBQTFCO0FBQ0EsTUFBSUMsT0FBSjtBQUVBLFFBQU1DLGVBQWUsR0FBR0gsT0FBTyxDQUFDQyxJQUFSLENBQWFHLE9BQWIsQ0FBcUIsSUFBckIsQ0FBeEI7O0FBQ0EsTUFBSUQsZUFBZSxLQUFLLENBQUMsQ0FBekIsRUFBNEI7QUFDMUJKLElBQUFBLFdBQVcsR0FBR0MsT0FBTyxDQUFDQyxJQUFSLENBQWFJLEtBQWIsQ0FBbUIsQ0FBbkIsRUFBc0JGLGVBQXRCLENBQWQ7QUFDQUQsSUFBQUEsT0FB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T0FBTyxDQUFDZ0QsSUFBUixDQUFhRixJQUFiO0FBQ0Q7O0FBQ0RqQyxRQUFBQSxPQUFPO0FBQ1IsT0FQRDs7QUFRQThCLE1BQUFBLFNBQVMsR0FBSU0sUUFBRCxJQUErQjtBQUN6Q0wsUUFBQUEsZUFBZTtBQUNmSixRQUFBQSxhQUFhLENBQUNTLFFBQUQsQ0FBYjtBQUNELE9BSEQ7O0FBSUFSLE1BQUFBLEtBQUssQ0FBQ3RCLEVBQU4sQ0FBUyxNQUFULEVBQWlCdUIsTUFBakI7QUFDQUQsTUFBQUEsS0FBSyxDQUFDdEIsRUFBTixDQUFTLFdBQVQsRUFBc0J3QixTQUF0QjtBQUNELEtBckJEOztBQXNCQUgsSUFBQUEsYUFBYSxDQUFDSixPQUFELENBQWI7QUFDRCxHQXhCSyxDQUFOO0FBeUJELENBM0VEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXBpLCBTdGFydE9wdGlvbnMgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2UvY29yZSc7XG5pbXBvcnQgeyBFbGVjdHJvblByb2Nlc3MgfSBmcm9tICdAZWxlY3Ryb24tZm9yZ2Uvc2hhcmVkLXR5cGVzJztcblxuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBwcm9ncmFtIGZyb20gJ2NvbW1hbmRlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0ICcuL3V0aWwvdGVybWluYXRlJztcbmltcG9ydCB3b3JraW5nRGlyIGZyb20gJy4vdXRpbC93b3JraW5nLWRpcic7XG5cbihhc3luYyAoKSA9PiB7XG4gIGxldCBjb21tYW5kQXJncyA9IHByb2Nlc3MuYXJndjtcbiAgbGV0IGFwcEFyZ3M7XG5cbiAgY29uc3QgZG91YmxlRGFzaEluZGV4ID0gcHJvY2Vzcy5hcmd2LmluZGV4T2YoJy0tJyk7XG4gIGlmIChkb3VibGVEYXNoSW5kZXggIT09IC0xKSB7XG4gICAgY29tbWFuZEFyZ3MgPSBwcm9jZXNzLmFyZ3Yuc2xpY2UoMCwgZG91YmxlRGFzaEluZGV4KTtcbiAgICBhcHBBcmdzID0gcHJvY2Vzcy5hcmd2LnNsaWNlKGRvdWJsZURhc2hJbmRleCArIDEpO1xuICB9XG5cbiAgbGV0IGRpciA9IHByb2Nlc3MuY3dkKCk7XG4gIHByb2dyYW1cbiAgICAudmVyc2lvbigoYXdhaXQgZnMucmVhZEpzb24ocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uL3BhY2thZ2UuanNvbicpKSkudmVyc2lvbilcbiAgICAuYXJndW1lbnRzKCdbY3dkXScpXG4gICAgLm9wdGlvbignLXAsIC0tYXBwLXBhdGggPHBhdGg+JywgJ092ZXJyaWRlIHRoZSBwYXRoIHRvIHRoZSBFbGVjdHJvbiBhcHAgdG8gbGF1bmNoIChkZWZhdWx0cyB0byBcXCcuXFwnKScpXG4gICAgLm9wdGlvbignLWwsIC0tZW5hYmxlLWxvZ2dpbmcnLCAnRW5hYmxlIGFkdmFuY2VkIGxvZ2dpbmcuICBUaGlzIHdpbGwgbG9nIGludGVybmFsIEVsZWN0cm9uIHRoaW5ncycpXG4gICAgLm9wdGlvbignLW4sIC0tcnVuLWFzLW5vZGUnLCAnUnVuIHRoZSBFbGVjdHJvbiBhcHAgYXMgYSBOb2RlLkpTIHNjcmlwdCcpXG4gICAgLm9wdGlvbignLS12c2NvZGUnLCAnVXNlZCB0byBlbmFibGUgYXJnIHRyYW5zZm9ybWF0aW9uIGZvciBkZWJ1Z2dpbmcgRWxlY3Ryb24gdGhyb3VnaCBWU0NvZGUuICBEbyBub3QgdXNlIHlvdXJzZWxmLicpXG4gICAgLm9wdGlvbignLWksIC0taW5zcGVjdC1lbGVjdHJvbicsICdUcmlnZ2VycyBpbnNwZWN0IG1vZGUgb24gRWxlY3Ryb24gdG8gYWxsb3cgZGVidWdnaW5nIHRoZSBtYWluIHByb2Nlc3MuICBFbGVjdHJvbiA+MS43IG9ubHknKVxuICAgIC5hY3Rpb24oKGN3ZCkgPT4geyBkaXIgPSB3b3JraW5nRGlyKGRpciwgY3dkKTsgfSlcbiAgICAucGFyc2UoY29tbWFuZEFyZ3MpO1xuXG4gIHByb2dyYW0ub24oJy0taGVscCcsICgpID0+IHtcbiAgICBjb25zb2xlLmxvZygnICBBbnkgYXJndW1lbnRzIGZvdW5kIGFmdGVyIFwiLS1cIiB3aWxsIGJlIHBhc3NlZCB0byB0aGUgRWxlY3Ryb24gYXBwLCBlLmcuJyk7XG4gICAgY29uc29sZS5sb2coJycpO1xuICAgIGNvbnNvbGUubG9nKCcgICAgJCBlbGVjdHJvbi1mb3JnZSAvcGF0aC90by9wcm9qZWN0IC1sIC0tIC1kIC1mIGZvby50eHQnKTtcbiAgICBjb25zb2xlLmxvZygnJyk7XG4gICAgY29uc29sZS5sb2coJyAgd2lsbCBwYXNzIHRoZSBhcmd1bWVudHMgXCItZCAtZiBmb28udHh0XCIgdG8gdGhlIEVsZWN0cm9uIGFwcCcpO1xuICB9KTtcblxuICBjb25zdCBvcHRzOiBTdGFydE9wdGlvbnMgPSB7XG4gICAgZGlyLFxuICAgIGludGVyYWN0aXZlOiB0cnVlLFxuICAgIGVuYWJsZUxvZ2dpbmc6ICEhcHJvZ3JhbS5lbmFibGVMb2dnaW5nLFxuICAgIHJ1bkFzTm9kZTogISFwcm9ncmFtLnJ1bkFzTm9kZSxcbiAgICBpbnNwZWN0OiAhIXByb2dyYW0uaW5zcGVjdEVsZWN0cm9uLFxuICB9O1xuXG4gIGlmIChwcm9ncmFtLnZzY29kZSAmJiBhcHBBcmdzKSB7XG4gICAgLy8gQXJncyBhcmUgaW4gdGhlIGZvcm1hdCB+YXJnfiBzbyB3ZSBuZWVkIHRvIHN0cmlwIHRoZSBcIn5cIlxuICAgIGFwcEFyZ3MgPSBhcHBBcmdzXG4gICAgICAubWFwKChhcmcpID0+IGFyZy5zdWJzdHIoMSwgYXJnLmxlbmd0aCAtIDIpKVxuICAgICAgLmZpbHRlcigoYXJnKSA9PiBhcmcubGVuZ3RoID4gMCk7XG4gIH1cblxuICBpZiAocHJvZ3JhbS5hcHBQYXRoKSBvcHRzLmFwcFBhdGggPSBwcm9ncmFtLmFwcFBhdGg7XG4gIGlmIChhcHBBcmdzKSBvcHRzLmFyZ3MgPSBhcHBBcmdzO1xuXG4gIGNvbnN0IHNwYXduZWQgPSBhd2FpdCBhcGkuc3RhcnQob3B0cyk7XG5cbiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICBjb25zdCBsaXN0ZW5Gb3JFeGl0ID0gKGNoaWxkOiBFbGVjdHJvblByb2Nlc3MpID0+IHtcbiAgICAgIGxldCBvbkV4aXQ6IE5vZGVKUy5FeGl0TGlzdGVuZXI7XG4gICAgICBsZXQgb25SZXN0YXJ0OiAobmV3Q2hpbGQ6IEVsZWN0cm9uUHJvY2VzcykgPT4gdm9pZDtcbiAgICAgIGNvbnN0IHJlbW92ZUxpc3RlbmVycyA9ICgpID0+IHtcbiAgICAgICAgY2hpbGQucmVtb3ZlTGlzdGVuZXIoJ2V4aXQnLCBvbkV4aXQpO1xuICAgICAgICBjaGlsZC5yZW1vdmVMaXN0ZW5lcigncmVzdGFydGVkJywgb25SZXN0YXJ0KTtcbiAgICAgIH07XG4gICAgICBvbkV4aXQgPSAoY29kZTogbnVtYmVyKSA9PiB7XG4gICAgICAgIHJlbW92ZUxpc3RlbmVycygpO1xuICAgICAgICBpZiAoc3Bhd25lZC5yZXN0YXJ0ZWQpIHJldHVybjtcbiAgICAgICAgaWYgKGNvZGUgIT09IDApIHtcbiAgICAgICAgICBwcm9jZXNzLmV4aXQoY29kZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfTtcbiAgICAgIG9uUmVzdGFydCA9IChuZXdDaGlsZDogRWxlY3Ryb25Qcm9jZXNzKSA9PiB7XG4gICAgICAgIHJlbW92ZUxpc3RlbmVycygpO1xuICAgICAgICBsaXN0ZW5Gb3JFeGl0KG5ld0NoaWxkKTtcbiAgICAgIH07XG4gICAgICBjaGlsZC5vbignZXhpdCcsIG9uRXhpdCk7XG4gICAgICBjaGlsZC5vbigncmVzdGFydGVkJywgb25SZXN0YXJ0KTtcbiAgICB9O1xuICAgIGxpc3RlbkZvckV4aXQoc3Bhd25lZCBhcyBFbGVjdHJvblByb2Nlc3MpO1xuICB9KTtcbn0pKCk7XG4iXX0=